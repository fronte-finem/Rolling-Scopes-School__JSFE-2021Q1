(()=>{"use strict";class t{constructor(){this.listeners=new Set}subscribe(t){this.listeners.add(t)}unsubscribe(t){this.listeners.delete(t)}notify(t){this.listeners.forEach((e=>e(t)))}}class e{constructor({stateStyle:t,hookElement:e,...s}){this.element=function({tag:t="div",styles:e,text:s}){const i=document.createElement(t);return Array.isArray(e)&&i.classList.add(...e),s&&(i.textContent=s),i}(s),this.mapStateStyle=new Map(t||[]),e&&e(this.element)}clear(){return this.element.innerHTML="",this}render(t){return this.clear(),this.element.append(...t.map((t=>t.element))),this}state(t,e=!0){const s=this.mapStateStyle.get(t);s&&this.element.classList.toggle(s,e)}getCssVar(t){return function(t,e){return getComputedStyle(t).getPropertyValue(e)}(this.element,t)}setCssVar(t,e){!function(t,e,s){t.style.setProperty(e,s)}(this.element,t,e)}onClick(t,e){this.element.addEventListener("click",t,e)}}class s extends e{constructor({stateStyle:t,activeStyle:e,...s}){super({stateStyle:[...t||[],["active",e]],...s})}active(t=!0){this.state("active",t)}}class i extends s{constructor({styles:t,...e}){super({...e,tag:"button",styles:["btn"].concat(t||[]),activeStyle:"btn--active"})}}class r extends s{constructor({url:t,styles:e,...s}){super({...s,tag:"a",styles:["link"].concat(e||[]),activeStyle:"link--active"}),this.element.href=t}}class a{static view({tag:t,childs:s,hookView:n,...o}){let c;switch(t){case"a":c=new r(o);break;case"button":c=new i(o);break;default:c=new e({tag:t,...o})}if(n&&n(c),s){const t=s.map((t=>t instanceof e?t:a.view(t)));c.render(t)}return c}}const n={page:"page--3u9twiGhj"};class o{constructor(t,{styles:e,...s}){this.title=t.toLowerCase(),this.view=a.view({styles:[n.page].concat(e||[]),...s})}get titleText(){return`${(t=this.title)[0].toUpperCase()}${t.slice(1).toLowerCase()}`;var t}get titleSafe(){return function(t,e="-"){return t.replace(" ",e)}(this.title)}get url(){return`#/${this.titleSafe}`}}const c="About";class h extends o{constructor(){super(c,{childs:[{tag:"h1",text:c}]})}}const l="card__side--1LRFLLbQu";class d extends e{constructor(t){super({styles:["card-container--2odSA5Wpq"],stateStyle:[["flip","card-container--card-flipped--2Il4JfSmK"],["error","card-container--card-error--8lL32UNVh"],["match","card-container--card-match--39DWNmHmF"]]});const e=a.view({styles:[l,"card__side--back--Ea9jNTQLz"]});e.element.style.backgroundImage=`url("./images/${t.backImage}")`;const s=a.view({styles:[l,"card__side--front--1UJHLOxA1"]});s.element.style.backgroundImage=`url("./images/${t.frontImage}")`;const i=a.view({styles:["card--2OuemdkNJ"],childs:[e,s]});this.render([i])}flip(t=!0){return this.state("flip",t),new Promise((t=>{this.element.addEventListener("transitionend",(()=>t()),{once:!0})}))}error(t=!0){this.state("error",t)}match(t=!0){this.state("match",t)}}class u{constructor(t){this.model=t,this.view=new d(t),this.model.onStateChange((t=>this.updateView(t)))}onClick(t){this.view.onClick((()=>t(this)))}updateView(t){this.view.flip(t.isFrontSide),this.view.error(t.isError),this.view.match(t.isMatch)}}const m={12:[4,3],16:[4,4],20:[5,4],24:[6,4],30:[6,5],36:[6,6],42:[7,6],48:[8,6],56:[8,7],64:[8,8]},w="--cards-columns",p="--cards-rows";class g{constructor(){this.view=a.view({styles:["cards-field--3pHJnqLWq"]})}render(t,e){this.view.clear();const[s,i]=m[e];this.columns=s,this.rows=i,this.view.render(t.map((t=>t.view)))}get columns(){return Number(this.view.getCssVar(w))}set columns(t){this.view.setCssVar(w,String(t))}get rows(){return Number(this.view.getCssVar(p))}set rows(t){this.view.setCssVar(p,String(t))}}class v{constructor(){this.listenersMap=new Map}subscribe(t,e){this.listenersMap.has(t)||this.listenersMap.set(t,new Set),this.listenersMap.get(t)?.add(e)}unsubscribe(t,e){this.listenersMap.get(t)?.delete(e)}notify(t,e){this.listenersMap.get(t)?.forEach((t=>t(e)))}}class y{constructor(t){this.observer=new v,this.state=this.proxify(t)}getState(){return{...this.state}}onStateChange(t){this.observer.subscribe("state-change",t)}proxify(t){return new Proxy(t,{set:(t,e,s)=>(t[e]=s,this.observer.notify("state-change",this.getState()),this.observer.notify(e,s),!0)})}static logChangeState(t,e,s){return`Changin ${t} property ${e} from ${t[e]} to ${s}`}}function b(t){return new Promise((e=>setTimeout(e,t)))}class f extends y{constructor(t,e=5){super({isError:!1,isStopped:!0,isSolved:!1,gameActiveCard:void 0,matchedCards:new Set,startTime:new Date,stopTime:new Date}),this.cards=t,this.startShowTime=e,this.cards=t}flipAll(t){this.cards.forEach((e=>e.flip(t)))}onDelayedStart(t){this.observer.subscribe("delayed-start",t)}onSolved(t){this.observer.subscribe("game-solved",t)}async start(){this.flipAll(!0),await b(1e3*this.startShowTime),this.flipAll(!1),this.state.isStopped=!1,this.state.startTime=new Date,this.observer.notify("delayed-start",this.state)}stop(){this.state.isStopped=!0,this.state.stopTime=new Date}get activeCard(){return this.state.gameActiveCard}async cardClickHandler(t){return!(this.state.isStopped||this.state.isError||this.state.matchedCards.has(t)||t===this.state.gameActiveCard||(t.click(),this.state.gameActiveCard?(this.match(t)||await this.error(t),0):(this.state.gameActiveCard=t,0)))}match(t){return t.frontImage===this.state.gameActiveCard?.frontImage&&(this.state.gameActiveCard.match(!0),t.match(!0),this.state.matchedCards.add(this.state.gameActiveCard),this.state.matchedCards.add(t),this.state.matchedCards.add(t),this.state.gameActiveCard=void 0,this.state.matchedCards.size===this.cards.length&&(this.state.isSolved=!0,this.stop(),this.observer.notify("game-solved",this.state)),!0)}async error(t){this.state.isError=!0,await Promise.all([this.state.gameActiveCard?.error(),t.error()]),this.state.isError=!1,this.state.gameActiveCard=void 0}get clicks(){const[t,e]=this.cards.reduce((([t,e],s)=>{const{clickedCount:i,errorCount:r}=s.getState();return[t+i,e+r]}),[0,0]);return{all:t,error:e}}get score(){const{all:t,error:e}=this.clicks,s=t-e,i=this.state.isStopped?this.state.stopTime:new Date,r=100*s-10*Math.round((i.getTime()-this.state.startTime.getTime())/1e3);return r<0?0:r}}class S extends y{constructor(t,e,s){super({isError:!1,isMatch:!1,isFrontSide:!1,clickedCount:0,errorCount:0}),this.id=t,this.frontImage=e,this.backImage=s}flip(t){this.state.isMatch||this.state.isError||(this.state.isFrontSide=t)}match(t){this.state.isMatch=t}async error(){this.state.isMatch||(this.state.errorCount+=1,this.state.isError=!0,await b(2e3),this.state.isError=!1,this.flip(!1))}click(){this.state.isMatch||this.state.isError||this.state.isFrontSide||(this.flip(!0),this.state.clickedCount+=1)}}function C(t){const e=t%60;return[e,(t-e)/60]}function k(t){const{hours:e,min:s,sec:i}=function(t){const[e,s]=C(t),[i,r]=C(s);return{hours:r,min:i,sec:e,diff:t}}(t);return{hours:String(e).padStart(2,"0"),min:String(s).padStart(2,"0"),sec:String(i).padStart(2,"0"),diff:t}}class T extends y{constructor(){super({startTime:0,currentTime:0,getTimeDiff(){return k(this.currentTime-this.startTime)}})}reset(t=0){window.clearInterval(this.timerId),this.state.startTime=0,this.state.currentTime=t}stop(){return window.clearInterval(this.timerId),this.getTimeDiff()}start(t=0){this.reset(t),this.timerId=window.setInterval((()=>this.increment()),1e3)}increment(){this.state.currentTime+=1}countdown(t=10){this.reset(t),this.timerId=window.setInterval((()=>this.decrement()),1e3);const e=t=>{t>0||(this.stop(),this.observer.unsubscribe("currentTime",e))};this.observer.subscribe("currentTime",e)}decrement(){this.state.currentTime-=1}getTimeDiff(){return k(this.state.currentTime-this.state.startTime)}}const x="timer__output--31hEcHHC4";class A extends e{constructor(t=":"){super({styles:["timer--2SuZkRdAu"],stateStyle:[["stop","timer--stop--2PmyrFaSs"],["countdown","timer--countdown--1TLvfk3Ju"]]}),this.output={seconds:a.view({styles:[x,"timer__output--seconds--LDvZlU8nv"]}),minutes:a.view({styles:[x,"timer__output--minutes--1UCpwt3JH"]}),hours:a.view({styles:[x,"timer__output--hours--2aIckO2AB"]})},this.render([a.view({styles:["timer__box--2BXeNzhpS"],childs:[this.output.hours,A.createSplitter(t),this.output.minutes,A.createSplitter(t),this.output.seconds]})])}show(t){this.output.seconds.element.textContent=t.sec,this.output.minutes.element.textContent=t.min,t.hours&&(this.output.hours.element.textContent=t.hours)}static createSplitter(t=":"){return a.view({styles:[x,"timer__output--splitter--1oPsqL_ha"],text:t})}}class L{constructor(){this.view=new A,this.model=new T,this.updateView(this.model.getState()),this.model.onStateChange((t=>this.updateView(t)))}updateView(t){this.view.show(t.getTimeDiff())}start(){this.model.start(),this.view.state("stop",!1),this.view.state("countdown",!1)}stop(){this.model.stop(),this.view.state("stop",!0)}countdown(t=10){this.model.countdown(t),this.view.state("countdown",!0)}}class E extends o{constructor(t){super("Game",{styles:["game--oAdyiODqM"],stateStyle:[["solved","game--solved--31jbL8GK1"]]}),this.cardImagesService=t,this.timer=new L,this.cardsField=new g,this.cards=[],this.view.render([this.timer.view,this.cardsField.view])}clear(){this.model=void 0,this.cards=[],this.cardsField.view.clear()}async newGame(t,e){this.clear();const s=(await this.cardImagesService.getUrls(t,e)).map(((t,e)=>new S(e,t,"")));this.model=new f(s,10),this.model.onDelayedStart((()=>this.timer.start())),this.model.onSolved((()=>{this.timer.stop(),this.view.state("solved",!0)})),this.cards=s.map((t=>new u(t))),this.cards.forEach((t=>t.onClick((()=>this.cardClickHandler(t))))),this.cardsField.render(this.cards,e),this.timer.countdown(10),this.model.start()}async cardClickHandler(t){return!!this.model&&this.model.cardClickHandler(t.model)}}const M="Settings";class I extends o{constructor(){super(M,{childs:[{tag:"h1",text:M}]})}}const _="Score";class V extends o{constructor(){super(_,{childs:[{tag:"h1",text:_}]})}}const D="Error";class F extends o{constructor(){super(D,{childs:[{tag:"h1",text:D}]})}}class P{constructor(){this.observer=new t,this.routes=new Map,this.pageError=new F,window.addEventListener("hashchange",(()=>this.notifyChange()))}onChange(t){this.observer.subscribe(t)}notifyChange(){this.observer.notify({page:this.currentRoute()})}currentRoute(){const t=this.getRoute(P.parseLocation());return P.updateTitle(t.titleText),t}getRoute(t){return this.routes.get(t)||this.pageError}addRoute(t,e){this.routes.set(`${t}`,e)}static parseLocation(){return window.location.hash||""}static updateTitle(t){document.title=`🎴 Match-Match 🃏 ${t} 🎴`}}const N={btnAuth:"register new player",btnStart:"start game"},$="btn--3_nlpgqen";class H{constructor(t){this.logo=new r({url:"#/about",styles:["logo--3sg1BTUO7"]}),this.btnAuth=new i({styles:[$,"btn-auth--3jK7P7wqE"],text:N.btnAuth}),this.btnStart=new i({styles:[$,"btn-start--2wNJ5mmAs"],text:N.btnStart}),this.btnAvatar=a.view({tag:"button",styles:["btn-avatar--24smYDawT"]}),this.navLinks=t.reduce(((t,{url:e,text:s})=>t.set(e,new r({url:e,styles:["nav-link--1twYtA65w"],text:s}))),new Map),this.view=a.view({tag:"header",styles:["header--2OIZ8JqQp"],childs:[{styles:["wrapper--1BnKpIkxb"],childs:[this.logo,{tag:"nav",styles:["nav-menu--2QqO7dr2y"],childs:[{tag:"ul",styles:["nav-items--3TeTVyPS5"],childs:[...this.navLinks.values()].map((t=>a.view({tag:"li",styles:["nav-item--2ZHqPFYA9"],childs:[t]})))}]},{styles:["controls--3FTTrayGa"],childs:[this.btnAuth,this.btnStart,this.btnAvatar]}]}]})}setActiveNavLink(t){this.activeNavLink?.active(!1),this.activeNavLink=this.navLinks?.get(t),this.activeNavLink?.active()}}function R(t){const e=t;for(let t=e.length-1;t>0;t-=1){const s=Math.floor((t+1)*Math.random());[e[s],e[t]]=[e[t],e[s]]}return e}const q="./images.json";class U{constructor(){this.jsonUrl=q}async fetch(){if(!this.cache){const t=await fetch(q),e=await t.json();this.cache=e.reduce(((t,e)=>t.set(e.category,e.images)),new Map)}return this.cache}async getUrls(t,e){let s=(await this.fetch()).get(t);return s?(s=s.map((e=>`${t}/${e}`)),s=R(s).slice(0,e/2),s=R(s.concat(s)),s):[]}}class j{constructor(t){this.router=new P,this.pages={about:new h,game:new E(new U),settings:new I,score:new V},this.header=new H(this.mapPages((t=>({url:t.url,text:t.titleText})))),this.pageContainer=new e({styles:["page-container--b6dWVQRAM"]}),this.view=a.view({tag:"main",styles:["app--3IALFfUtx"],childs:[this.header.view,this.pageContainer]}),this.router.addRoute("",this.pages.about),this.mapPages((t=>this.router.addRoute(t.url,t))),this.router.onChange((({page:t})=>this.update(t))),t.append(this.view.element)}mapPages(t){return Object.values(this.pages).map(t)}update(t){this.pageContainer.render([t.view]),this.header.setActiveNavLink(t.url)}async start(){window.location.hash=this.pages.game.url,this.update(this.router.currentRoute()),await this.pages.game.newGame("cats",12)}}window.addEventListener("load",(()=>{document.body.classList.add("root"),new j(document.body).start()}))})();