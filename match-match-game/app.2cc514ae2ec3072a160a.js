(()=>{"use strict";class t{constructor(){this.listeners=new Set}subscribe(t){this.listeners.add(t)}unsubscribe(t){this.listeners.delete(t)}notify(t){this.listeners.forEach((e=>e(t)))}}function e(t){return`${t[0].toUpperCase()}${t.slice(1).toLowerCase()}`}const s="http://www.w3.org/2000/svg";class a{constructor({statesClassNames:t,hookElement:e,...s}){this.element=function({tag:t="div",classNames:e,text:s}){const a=document.createElement(t);return Array.isArray(e)&&a.classList.add(...e),s&&(a.textContent=s),a}(s),this.mapStateStyle=new Map(t||[]),e&&e(this.element)}getText(){return this.element.textContent}setText(t){this.element.textContent=t}clear(){return this.element.innerHTML="",this}render(t){return this.clear(),Array.isArray(t)?this.element.append(...t.map((t=>t.element))):this.element.append(t.element),this}setCssState(t,e=!0){const s=this.mapStateStyle.get(t);s&&this.element.classList.toggle(s,e)}getCssVar(t){return function(t,e){return getComputedStyle(t).getPropertyValue(e)}(this.element,t)}setCssVar(t,e){!function(t,e,s){t.style.setProperty(e,s)}(this.element,t,e)}onClick(t,e){this.element.addEventListener("click",t,e)}}class i extends a{constructor({statesClassNames:t,activeStateClassName:e,...s}){super({statesClassNames:[...t||[],["active",e]],...s})}active(t=!0){this.setCssState("active",t)}}class r extends i{constructor({classNames:t,...e}){super({...e,tag:"button",classNames:["btn"].concat(t||[]),activeStateClassName:"btn--active"})}}class n extends i{constructor({url:t,classNames:e,...s}){super({...s,tag:"a",classNames:["link"].concat(e||[]),activeStateClassName:"link--active"}),this.element.href=t}}class o{static view({tag:t,childs:e,hookView:s,...i}){let c;switch(t){case"a":c=new n(i);break;case"button":c=new r(i);break;default:c=new a({tag:t,...i})}if(s&&s(c),e){const t=e.map((t=>t instanceof a?t:o.view(t)));c.render(t)}return c}}const c={page:"page--1AFmu1ZbC"};class h{constructor(t,{classNames:e,...s}){this.title=t.toLowerCase(),this.view=o.view({classNames:[c.page].concat(e||[]),...s})}init(){var t;document.title=`🎴 Match-Match 🃏 ${t=this.titleText,t.split(" ").map(e).join(" ")} 🎴`}stop(){console.log(this,"⚠️ Method stop not implemented ⚠️")}get titleText(){return this.title}get titleSafe(){return function(t,e="-"){return t.replace(" ",e)}(this.title)}get url(){return`#/${this.titleSafe}`}}const l="about game";class d extends h{constructor(){super(l,{childs:[{tag:"h1",text:l}]})}}const u="card__side--1YnFocLsV";class m extends a{constructor(t){super({classNames:["card-container--i0yIuD8uN"],statesClassNames:[["flip","card-container--card-flipped--3DmvLAZdY"],["error","card-container--card-error--1mMyluopx"],["match","card-container--card-match--2GNo8oo8P"]]});const e=o.view({classNames:[u,"card__side--back--1vG-3cHdj"]});e.element.style.backgroundImage=`url("./images/${t.backImage}")`;const s=o.view({classNames:[u,"card__side--front--1toEdlg30"]});s.element.style.backgroundImage=`url("./images/${t.frontImage}")`;const a=o.view({classNames:["card--19lZCi7QM"],childs:[e,s]});this.render(a)}flip(t=!0){return this.setCssState("flip",t),new Promise((t=>{this.element.addEventListener("transitionend",(()=>t()),{once:!0})}))}error(t=!0){this.setCssState("error",t)}match(t=!0){this.setCssState("match",t)}}class g{constructor(t){this.model=t,this.view=new m(t),this.model.onStateChange((t=>this.updateView(t)))}onClick(t){this.view.onClick((()=>t(this)))}async updateView(t){await this.view.flip(t.isFrontSide),this.view.error(t.isError),this.view.match(t.isMatch)}}const p={12:[4,3],16:[4,4],20:[5,4],24:[6,4],30:[6,5],36:[6,6],42:[7,6],48:[8,6],56:[8,7],64:[8,8]},w="--cards-columns",v="--cards-rows";class S{constructor(){this.view=o.view({classNames:["cards-field--1SU6hNcue"]})}render(t,e){this.view.clear();const[s,a]=p[e];this.columns=s,this.rows=a,this.view.render(t.map((t=>t.view)))}get columns(){return Number(this.view.getCssVar(w))}set columns(t){this.view.setCssVar(w,String(t))}get rows(){return Number(this.view.getCssVar(v))}set rows(t){this.view.setCssVar(v,String(t))}}class C{constructor(){this.listenersMap=new Map}subscribe(t,e){this.listenersMap.has(t)||this.listenersMap.set(t,new Set),this.listenersMap.get(t)?.add(e)}unsubscribe(t,e){this.listenersMap.get(t)?.delete(e)}notify(t,e){this.listenersMap.get(t)?.forEach((t=>t(e)))}}class f{constructor(t){this.observer=new C,this.state=this.proxify(t)}getState(){return{...this.state}}onStateChange(t){this.observer.subscribe("state-change",t)}proxify(t){return new Proxy(t,{set:(t,e,s)=>(t[e]=s,this.observer.notify("state-change",this.getState()),this.observer.notify(e,s),!0)})}static logChangeState(t,e,s){return`Changin ${String(t)} property ${e} from ${String(t[e])} to ${String(s)}`}}class b extends f{constructor(t){super({isError:!1,isStopped:!0,isSolved:!1,gameActiveCard:void 0,matchedCards:new Set,startTime:new Date,stopTime:new Date}),this.cards=t,this.cards=t}flipAll(t){this.cards.forEach((e=>e.flip(t)))}onSolved(t){this.observer.subscribe("game-solved",t)}showAllCards(){this.flipAll(!0)}start(){this.flipAll(!1),this.state.isStopped=!1,this.state.startTime=new Date}stop(){this.state.isStopped=!0,this.state.stopTime=new Date}get activeCard(){return this.state.gameActiveCard}async cardClickHandler(t){return!(this.state.isStopped||this.state.isError||this.state.matchedCards.has(t)||t===this.state.gameActiveCard||(t.click(),this.state.gameActiveCard?(this.match(t)||await this.error(t),0):(this.state.gameActiveCard=t,0)))}match(t){return t.frontImage===this.state.gameActiveCard?.frontImage&&(this.state.gameActiveCard.match(!0),t.match(!0),this.state.matchedCards.add(this.state.gameActiveCard),this.state.matchedCards.add(t),this.state.matchedCards.add(t),this.state.gameActiveCard=void 0,this.state.matchedCards.size===this.cards.length&&(this.state.isSolved=!0,this.stop(),this.observer.notify("game-solved",this.state)),!0)}async error(t){this.state.isError=!0,await Promise.all([this.state.gameActiveCard?.error(),t.error()]),this.state.isError=!1,this.state.gameActiveCard=void 0}get clicks(){const[t,e]=this.cards.reduce((([t,e],s)=>{const{clickedCount:a,errorCount:i}=s.getState();return[t+a,e+i]}),[0,0]);return{all:t,error:e}}get score(){const{all:t,error:e}=this.clicks,s=t-e,a=this.state.isStopped?this.state.stopTime:new Date,i=100*s-10*Math.round((a.getTime()-this.state.startTime.getTime())/1e3);return i<0?0:i}}class N extends f{constructor(t,e,s){super({isError:!1,isMatch:!1,isFrontSide:!1,clickedCount:0,errorCount:0}),this.id=t,this.frontImage=e,this.backImage=s}flip(t){this.state.isMatch||this.state.isError||(this.state.isFrontSide=t)}match(t){this.state.isMatch=t}async error(){this.state.isMatch||(this.state.errorCount+=1,this.state.isError=!0,await(2e3,new Promise((t=>setTimeout(t,2e3)))),this.state.isError=!1,this.flip(!1))}click(){this.state.isMatch||this.state.isError||this.state.isFrontSide||(this.flip(!0),this.state.clickedCount+=1)}}function y(t){const e=t%60;return[e,(t-e)/60]}function k(t){const{hours:e,min:s,sec:a}=function(t){const[e,s]=y(t),[a,i]=y(s);return{hours:i,min:a,sec:e,diff:t}}(t);return{hours:String(e).padStart(2,"0"),min:String(s).padStart(2,"0"),sec:String(a).padStart(2,"0"),diff:t}}class x extends f{constructor(){super({startTime:0,currentTime:0,getTimeDiff(){return k(this.currentTime-this.startTime)}})}reset(t=0){window.clearInterval(this.timerId),this.state.startTime=0,this.state.currentTime=t}stop(){return window.clearInterval(this.timerId),this.getTimeDiff()}start(t=0){this.reset(t),this.timerId=window.setInterval((()=>this.increment()),1e3)}async countdown(t=10){return new Promise((e=>{this.reset(t),this.timerId=window.setInterval((()=>{this.decrement(),this.state.currentTime>0||(this.reset(),e())}),1e3)}))}increment(){this.state.currentTime+=1}decrement(){this.state.currentTime-=1}getTimeDiff(){return k(this.state.currentTime-this.state.startTime)}}const M="timer__output--2TxoOB91B";class L extends a{constructor(t=":"){super({classNames:["timer--3hmDgpm1E"],statesClassNames:[["stop","timer--stop--3hJx4Xln3"],["countdown","timer--countdown--1I-_ImbQN"]]}),this.output={seconds:o.view({classNames:[M,"timer__output--seconds--m2fBlsDJB"]}),minutes:o.view({classNames:[M,"timer__output--minutes--1dMtRHovH"]}),hours:o.view({classNames:[M,"timer__output--hours--11f_qoGHw"]})},this.render(o.view({classNames:["timer__box--22sYiA39u"],childs:[this.output.hours,L.createSplitter(t),this.output.minutes,L.createSplitter(t),this.output.seconds]}))}show(t){this.output.seconds.element.textContent=t.sec,this.output.minutes.element.textContent=t.min,t.hours&&(this.output.hours.element.textContent=t.hours)}static createSplitter(t=":"){return o.view({classNames:[M,"timer__output--splitter--3RPQD9d0b"],text:t})}}class T{constructor(){this.view=new L,this.model=new x,this.updateView(this.model.getState()),this.model.onStateChange((t=>this.updateView(t)))}updateView(t){this.view.show(t.getTimeDiff())}start(){this.model.start(),this.view.setCssState("stop",!1),this.view.setCssState("countdown",!1)}stop(){this.model.stop(),this.view.setCssState("stop",!0)}reset(){this.model.reset(),this.view.setCssState("stop",!1),this.view.setCssState("countdown",!1)}async countdown(t=10){this.view.setCssState("countdown",!0),await this.model.countdown(t)}}class A extends h{constructor(t){super("game",{classNames:["game--3_WFWXfxo"],statesClassNames:[["solved","game--solved--2M0U5Nryc"]]}),this.cardImagesService=t,this.timer=new T,this.cardsField=new S,this.cards=[],this.view.render([this.timer.view,this.cardsField.view])}clear(){this.model=void 0,this.cards=[],this.cardsField.view.clear()}init(){this.newGame("dogs",12).then((()=>{}),(()=>{}))}stop(){this.stopGame(),console.log("Game stopped:",this)}async newGame(t,e){this.clear();const s=await this.cardImagesService.getUrls(t,e);if(!s)return;const a=s.front.map(((t,e)=>new N(e,t,s.back)));this.cards=a.map((t=>new g(t))),this.cards.forEach((t=>t.onClick((()=>this.cardClickHandler(t))))),this.cardsField.render(this.cards,e),this.model=new b(a),this.model.showAllCards(),await this.timer.countdown(5),this.model.start(),this.timer.start(),this.model.onSolved((()=>{this.timer.stop(),this.view.setCssState("solved",!0)}))}stopGame(){this.timer.reset(),this.model?.stop(),this.clear()}async cardClickHandler(t){return!!this.model&&this.model.cardClickHandler(t.model)}}const I="game settings";class E extends h{constructor(){super(I,{childs:[{tag:"h1",text:I}]})}}const P="best score";class R extends h{constructor(){super(P,{childs:[{tag:"h1",text:P}]})}}const _="error 404";class $ extends h{constructor(){super(_,{childs:[{tag:"h1",text:_}]})}}class B{constructor(e){this.initialPage=e,this.observer=new t,this.routes=new Map,this.errorPage=new $,this.addRoute("",e),this.currentPage=e,window.addEventListener("hashchange",(()=>this.observer.notify(this.updateCurrentRoute())))}onChange(t){this.observer.subscribe(t)}addRoute(t,e){return this.routes.set(`${t}`,e),this}getRoutes(){return[...this.routes.values()]}getRoute(t){return this.routes.get(t)||this.errorPage}activateRoute(t){window.location.hash=this.getRoute(t).url}updateCurrentRoute(){const t=B.getCurrentPath(),e=this.getRoute(t),s=this.currentPage;return s!==e&&(s.stop(),e.init(),this.currentPage=e),{oldPage:s,newPage:e}}static getCurrentPath(){return window.location.hash||""}}const V=[{page:"game",title:"about game",url:"#/about-game",svgIconLink:"./svg/sprite.svg#icon-question-mark"},{page:"score",title:"best score",url:"#/best-score",svgIconLink:"./svg/sprite.svg#icon-star"},{page:"settings",title:"game settings",url:"#/game-settings",svgIconLink:"./svg/sprite.svg#icon-gear"}],D={signUp:"register new player",start:"start game",stop:"stop game"};class H extends a{constructor(){super({tag:"nav",classNames:["nav-menu--oq7N5R5oz"]}),this.navList=o.view({tag:"ul",classNames:["nav-items--ClElNpQa4"]}),this.render(this.navList)}addNavLinks(t){this.navLinks=t.reduce(((t,{url:e,...s})=>t.set(e,H.createNavLink({url:e,...s}))),new Map),this.navList.render(H.createNavItems([...this.navLinks.values()]))}setActiveNavLink(t){this.activeNavLink?.active(!1),this.activeNavLink=this.navLinks?.get(t),this.activeNavLink?.active()}static createNavItems(t){return t.map((t=>o.view({tag:"li",classNames:["nav-item--tNzLKtmzy"],childs:[t]})))}static createNavLink({url:t,title:e,svgIconLink:a}){return new n({url:t,classNames:["nav-link--3vlnkh93B"],text:e,hookElement:t=>t.append(function(t,e){const a=document.createElementNS(s,"svg"),i=document.createElementNS(s,"use");return i.setAttribute("href",t),a.append(i),a.classList.add("svg-icon"),Array.isArray(e)&&a.classList.add(...e),a}(a,["svg-icon--2ZlcA-p-O"]))})}}class F{constructor(t){this.initialState=t,this.statesMap=new Map,this.currentState=t,this.addState(t)}addState(t){return this.statesMap.set(t.name,t),this}getCurrentState(){return this.currentState.name}applyCurrentState(t,e=!0){const s=this.currentState.name;this.currentState.apply(t),this.currentState=this.statesMap.get(this.currentState.next)||this.initialState,e&&t.observer.notify(s,s)}}class U extends class{constructor(t,e){this.name=t,this.next=e}apply(t){throw new Error(`⚠️ Method not implemented. This state: ${String(this.name)}. This context: ${String(t)} ⚠️`)}}{constructor(t,e,s,a){super(t,e),this.name=t,this.next=e,this.btnText=s,this.hideAvatar=a}apply(t){t.btnStateSwitch.setText(this.btnText),t.avatar.setCssState("hidden",this.hideAvatar)}}class G extends a{constructor(){super({tag:"header",classNames:["header--1NncKmEQQ"]}),this.observer=new C,this.stateMashine=new F(new U("initial","ready",D.signUp,!0)).addState(new U("ready","game",D.start,!1)).addState(new U("game","ready",D.stop,!1)),this.logo=new n({url:"./",classNames:["logo--3qnSiQFY3"]}),this.menu=new H,this.avatar=new n({url:"#/score",classNames:["avatar--1ZdwmxlvE"],statesClassNames:[["hidden","avatar--hidden--16fndReds"]]}),this.btnStateSwitch=new r({classNames:["btn--2XTPIrVcX","btn-state-switch--1kI9X1ZWl"],statesClassNames:[["hidden","btn--hidden--1cPXNsYdt"]]}),this.render(o.view({classNames:["wrapper--3rfyi-BeM"],childs:[this.logo,this.menu,this.btnStateSwitch,this.avatar]})),this.stateMashine.applyCurrentState(this),this.btnStateSwitch.onClick((()=>this.stateMashine.applyCurrentState(this)))}getCurrentState(){return this.stateMashine.getCurrentState()}nextState(){this.stateMashine.applyCurrentState(this,!1)}}class Q{constructor(){this.observer=new C,this.view=new G}addNavLinks(t){this.view.menu.addNavLinks(t)}setActiveNavLink(t){this.view.menu.setActiveNavLink(t)}}function Z(t){const e=t;for(let t=e.length-1;t>0;t-=1){const s=Math.floor((t+1)*Math.random());[e[s],e[t]]=[e[t],e[s]]}return e}const X="./images.json";class j{constructor(){this.jsonUrl=X}async fetch(){if(!this.cache){const t=await fetch(X),e=await t.json();this.cache=e.reduce(((t,e)=>t.set(e.category,e.images)),new Map)}return this.cache}async generateUrls(t){const e=(await this.fetch()).get(t);if(e)return{front:Array.from({length:e.last-e.first},((s,a)=>`${t}/${String(a+e.first).padStart(e.leftPad,e.leftPadChar)}.${e.extension}`)),back:e.cardCover}}async getUrls(t,e){const s=await this.generateUrls(t);if(!s)return;let{front:a}=s;return a=Z(a).slice(0,e/2),a=Z(a.concat(a)),{front:a,back:s.back}}}class z{constructor(t){this.header=new Q,this.router=new B(new d),this.gameStoppedByButton=!1,this.router.addRoute("#/about-game",this.router.initialPage).addRoute("#/game",new A(new j)).addRoute("#/game-settings",new E).addRoute("#/best-score",new R),this.router.onChange((t=>this.applayRouteChange(t))),this.initHeader(),this.pageContainer=new a({classNames:["page-container--2BzkQwOZo"]}),this.view=o.view({tag:"main",classNames:["app--2_KmwgIsG"],childs:[this.header.view,this.pageContainer]}),t.append(this.view.element)}start(){window.location.hash=this.router.initialPage.url,this.applayRouteChange(this.router.updateCurrentRoute())}applayRouteChange({oldPage:t,newPage:e}){t!==this.router.getRoute("#/game")||this.gameStoppedByButton||this.header.view.nextState(),this.pageContainer.render(e.view),this.header.setActiveNavLink(e.url)}initHeader(){this.header.addNavLinks(V),this.header.view.observer.subscribe("game",(t=>this.applayHeaderState(t))),this.header.view.observer.subscribe("ready",(t=>this.applayHeaderState(t)))}applayHeaderState(t){switch(t){case"game":this.gameStoppedByButton=!1,this.router.activateRoute("#/game");break;case"ready":"#/game"===B.getCurrentPath()&&(this.gameStoppedByButton=!0,this.router.activateRoute("#/about-game"))}}}window.addEventListener("load",(()=>{document.body.classList.add("root"),new z(document.body).start()}))})();