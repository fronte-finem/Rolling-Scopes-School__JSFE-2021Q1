(()=>{"use strict";const t="btn--2WpXrPgI1",e="active--2tNpRN1xk";let s;!function(t){t.ABOUT="about",t.GARAGE="garage",t.WINNERS="winners"}(s||(s={}));function i(t,{tag:e="div",parent:s}={}){const i=document.createElement(e);return i.classList.add(...Array.isArray(t)?t:[t]),s&&s.append(i),i}function a(t){const e=document.createElement("template");return e.innerHTML=t,e.content.firstElementChild}class n{getRoot(){return this.root}constructor(t,e){this.root=i(t,e)}setCssState(t,e){this.root.classList.toggle(t,e)}setCssStateAsync(t,e){return this.root.classList.toggle(t,e),new Promise((t=>{this.root.addEventListener("transitionend",(()=>t()),{once:!0})}))}getCssVar(t){return function(t,e){return getComputedStyle(t).getPropertyValue(e)}(this.root,t)}setCssVar(t,e){!function(t,e,s){t.style.setProperty(e,s)}(this.root,t,e)}setCssStyle(t,e){this.root.style[t]=e}onClick(t,e){this.root.addEventListener("click",t,e)}}const r="btn-process--3IX__tdei",o="btn-paginator--hIA-wAZFL";let h;!function(t){t.DEFAULT="default",t.START="start",t.STOP="stop",t.NEXT="next",t.PREV="prev",t.NO_TEXT="delete",t.CUSTOM="custom",t.ROUTE="route"}(h||(h={}));class c extends n{constructor(t="",e=h.DEFAULT,s){super(((t=h.DEFAULT,e)=>{const s=(t=>{switch(t){case h.START:return[r,"start--1MJZ6TKsG"];case h.STOP:return[r,"stop--3awnw9pRV"];case h.NEXT:return[o,"next--N-4z3NFTi"];case h.PREV:return[o,"prev--1g6lHKdln"];case h.NO_TEXT:return["btn-no-text--2hGC24VAJ"];case h.CUSTOM:return[];case h.ROUTE:return["btn-route--2IJsR23sR"];case h.DEFAULT:default:return["button--191tdEwmU"]}})(t);return e?s.concat(Array.isArray(e)?e:[e]):s})(e,s),{tag:"button"}),this.update(t)}update(t){this.root.textContent=t}switch(t=!0){this.root.disabled=!t}enable(){this.switch()}disable(){this.switch(!1)}}let l;!function(t){t.HIDDEN="hidden",t.VISIBLE="visible"}(l||(l={}));class d extends n{constructor(){super("modal--3Df_I9THw"),this.hide()}update(t){const e=t===l.HIDDEN;this.setCssState("hidden--k9ZbS_xCi",e),document.body.classList.toggle("body-hidden--2oHUPUxwA",!e)}hide(){this.update(l.HIDDEN)}show(){this.update(l.VISIBLE)}}const u="hidden--My18nl3md";let p,g;!function(t){t.HIDDEN="hidden",t.VISIBLE="visible"}(p||(p={}));class m extends n{header=i("header--mxD9cbWG7",{tag:"header"});content=i("content--2SkI5oqgx");btnClose=new c("",h.NO_TEXT,"btn-close--13xSSIKOb");constructor(t){super("popup--23aQaCACL"),this.modal=t,this.build(),this.initBinds()}build(){this.root.append(this.header,this.content,this.btnClose.getRoot()),this.setCssStateAsync(u,!0)}initBinds(){this.modal.onClick((()=>this.hide())),this.btnClose.onClick((()=>this.hide()))}showText(t,e){this.header.textContent=t,this.content.textContent=e,this.show()}render(t,e){this.header.textContent=t,this.content.append(e),this.show()}async hide(){this.modal.hide(),document.body.removeEventListener("keydown",this.escapeListener),await this.setCssStateAsync(u,!0),this.header.innerHTML="",this.content.innerHTML="",this.onHide?.()}show(){this.modal.show(),this.setCssState(u,!1),document.body.addEventListener("keydown",this.escapeListener,{once:!0}),this.onShow?.()}escapeListener=t=>{"Escape"===t.code&&this.hide()}}!function(t){t[t.GARAGE_ERROR=0]="GARAGE_ERROR",t[t.RACE_WIN=1]="RACE_WIN",t[t.RACE_END=2]="RACE_END",t[t.RACE_RESET=3]="RACE_RESET",t[t.START=4]="START",t[t.STOP=5]="STOP",t[t.EMPTY=6]="EMPTY"}(g||(g={}));const E="#000000";let w,R;!function(t){t.INITIAL="initial",t.START="start",t.STOP="stop",t.DRIVE="race",t.BROKEN="broken",t.FINISH="finish"}(w||(w={})),function(t){t.COLOR="--color1",t.POSITION="--position",t.LEG_TIME="--leg-time",t.EYE_TIME="--eye-time",t.EYE_DELAY="--eye-delay",t.BODY_TIME="--body-time",t.BODY_DELAY="--body-delay"}(R||(R={}));class S{id=-1;name="";color=E;state=w.INITIAL;position=0;wins=0;winTime=NaN;duration=null;get time(){return Number(((this.duration||NaN)/1e3).toFixed(2))}constructor(t,e){t&&(this.id=t.id,this.name=t.name,this.color=t.color),e&&(this.wins=e.wins,this.winTime=e.time)}get carDTO(){return{id:this.id,name:this.name,color:this.color}}reset(){this.id=-1,this.name="",this.color=E,this.position=0}update({name:t,color:e}){return this.name=t,this.color=e,this.onUpdate?.(this),this}updateWin({wins:t,time:e}){this.wins=t,this.winTime=e,this.onUpdate?.(this),this.onUpdateWin?.(this)}driveStart(t){return this.state=w.START,this.duration=t,this.onDrive?.(this),this}driveDead(){return this.state=w.BROKEN,this.onDrive?.(this),this}driveFinish(){return this.state=w.FINISH,this.onDrive?.(this),this}driveReset(){return this.state=w.INITIAL,this.position=0,this.onDrive?.(this),this}driveMove(){return this.duration?(this.state=w.DRIVE,this.onDrive?.(this),this.driveAnimate(this.duration),this):this}driveAnimate(t){let e=-1;const s=i=>{if(this.state!==w.DRIVE)return;-1===e&&(e=i);const a=i-e;this.position=100*Math.min(a/t,1),a<t&&window.requestAnimationFrame(s),this.onDrive?.(this)};window.requestAnimationFrame(s)}}const b="hidden--31Pvs2zLy",T="start--yZt0kpRva",C="run--3IccbmaHP",v="dead--29B1Oma7n",f="finish--_qQZE3gbP",y="btn--UNu0CbLSC",A="eye--2q-OCopyB",M="leg--yfPjiDGFz",I="leg1--2bU_q-CeA",P="leg2--2m3WSNtgo",D="leg3--2ANXbS6-g",N="leg-left--xrFNpC8f0",O="leg-right--l5cToLYPo";class L extends n{stateMap=new Map;btnUpdate=new c("Update",h.CUSTOM,[y,"update--1oMPL-LQc"]);btnRemove=new c("Delete",h.CUSTOM,[y,"delete--2QqhGWase"]);btnCancel=new c("Cancel",h.CUSTOM,[y,"cancel--la4Y01FwS"]);carModel=null;constructor(t,e=!1,s=[]){super(["car--3rvQqyq8b",...s]),this.passive=e,this.build(),this.init(),this.initStateMap(),this.stateMap.get(w.INITIAL)?.(),this.update(t)}build(){const t=i([A,"eye--left--3_ASXcWDv"]),e=i([A,"eye--right--1P-CANYXq"]),s=i([M,N,I]),a=i([M,N,P]),n=i([M,N,D]),r=i([M,O,I]),o=i([M,O,P]),h=i([M,O,D]),c=i("body--3bgk0PFtN"),l=i("body__cover--1oichIJ96");this.selectTarget=l,c.append(s,a,n,r,o,h,l),l.append(t,e),this.root.append(c,this.btnUpdate.getRoot(),this.btnRemove.getRoot(),this.btnCancel.getRoot()),this.setCssState("passive--v3Oixi1yG",this.passive)}init(){this.onClick((t=>{this.select(t.target!==this.btnRemove.getRoot()&&t.target!==this.btnCancel.getRoot())})),this.btnUpdate.onClick((()=>this.requestUpdate())),this.btnRemove.onClick((()=>this.requestRemove()))}deselect=()=>{this.select(!1)};select(t=!0){this.setCssState("select--2hPNGdcnE",t),t&&this.onSelect&&this.onSelect()}requestUpdate(){this.onRequestUpdate&&(document.body.removeEventListener("click",this.deselect),this.select(!1),this.onRequestUpdate())}requestRemove(){this.onRequestRemove&&(document.body.removeEventListener("click",this.deselect),this.select(!1),this.onRequestRemove())}initStateMap(){this.stateMap.set(w.INITIAL,(()=>this.toInitialState())),this.stateMap.set(w.START,(()=>this.toStartState())),this.stateMap.set(w.DRIVE,(t=>this.toRunState(t))),this.stateMap.set(w.BROKEN,(()=>this.toDeadState())),this.stateMap.set(w.FINISH,(()=>this.toFinishState()))}toInitialState(){this.setCssState(b,!1),this.setCssState(T,!1),this.setCssState(C,!1),this.setCssState(v,!1),this.setCssState(f,!1),[[R.POSITION,"0%"],[R.LEG_TIME,`${1+Math.random()}s`],[R.EYE_TIME,"5s"],[R.EYE_DELAY,5*Math.random()+"s"],[R.BODY_TIME,`${2+Math.random()}s`],[R.BODY_DELAY,`${Math.random()}s`]].forEach((([t,e])=>{this.setCssVar(t,e)}))}toStartState(){this.setCssState(T,!0),[[R.LEG_TIME,`${Math.random()}s`],[R.EYE_TIME,"3s"],[R.EYE_DELAY,.2*Math.random()+"s"],[R.BODY_TIME,`${Math.random()}s`],[R.BODY_DELAY,.2*Math.random()+"s"]].forEach((([t,e])=>{this.setCssVar(t,e)}))}toRunState(t){var e;t?.position?this.setCssVar(R.POSITION,`${t.position}%`):(this.setCssState(T,!1),this.setCssState(C,!0),(e=(t?.duration||10)/10,[[R.LEG_TIME,`${e}ms`],[R.EYE_TIME,"3s"],[R.EYE_DELAY,`${Math.random()}s`],[R.BODY_TIME,2*e+"ms"],[R.BODY_DELAY,`${Math.random()}s`]]).forEach((([t,e])=>{this.setCssVar(t,e)})))}toDeadState(){this.setCssState(C,!1),this.setCssState(v,!0),[[R.LEG_TIME,"1s"],[R.EYE_TIME,"10s"],[R.EYE_DELAY,`${Math.random()}s`],[R.BODY_TIME,"5s"],[R.BODY_DELAY,`${Math.random()}s`]].forEach((([t,e])=>{this.setCssVar(t,e)}))}toFinishState(t){var e;this.setCssState(C,!1),this.setCssState(f,!0),(e=(t?.duration||10)/10,[[R.EYE_TIME,"5s"],[R.EYE_DELAY,`${Math.random()}s`],[R.BODY_TIME,2*e+"s"],[R.BODY_DELAY,`${Math.random()}s`]]).forEach((([t,e])=>{this.setCssVar(t,e)}))}update(t){this.carModel=t,t?(this.setCssState(b,!1),this.setCssVar(R.COLOR,t.color)):this.setCssState(b,!0)}applayDTO(t){this.setCssVar(R.COLOR,t.color)}applyCarModelState(t){this.setCssState("btn-to-left--1dnVYq67J",t.position>50),this.stateMap.get(t.state)?.(t)}}function U(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function _(){const[t,e,s]=[U(0,359),Math.random(),Math.random()];return function(t,e,s){const[i,a,n]=function(t,e,s){const i=e*Math.min(s,1-s),a=(e,a=(e+t/30)%12)=>s-i*Math.max(Math.min(a-3,9-a,1),-1);return[a(0),a(8),a(4)]}(t,e,s);return function(t,e,s){return`#${[t,e,s].map((t=>Math.round(255*t).toString(16).padStart(2,"0"))).join("")}`}(i,a,n)}(t,e<.75?1-e:e,.5+(.5-s)/2)}const x="hidden--2hzuHT1QT",q=()=>`<span class="bug--1JLt3MKkB" style="--flicker-delay:${Math.random()}s; --color:${_()}">&lt;BUG&gt;</span>`,G={title:`<h1 class="title--NZB02zoMr">Async ${q()} Race</h1>`,greet:'\n  <h2 class="greet--1zKM1vpjn">Welcome fellow \n    <a class="link--1YAaTBu46" href="https://github.com/rolling-scopes-school/tasks/blob/master/tasks/async-race.md">async-racers</a>!\n   üòÅ\n  </h2>',remind:'\n  <p class="remind--9fEr1pITO">To participate in the race, you need to start the\n    <a class="link--1YAaTBu46" href="https://github.com/mikhama/async-race-api">server</a>.\n  </p>',features:`\n  <div class="features--1FT35BRdy">\n    <h3 class="features__title--3-wDq14LN">Suported features:</h3>\n    <ul class="features__list--1ivKMakhr">\n      <li class="features__item--X99Hrlr0C">Create custom ${q()}</li>\n      <li class="features__item--X99Hrlr0C">For select ${q()} juct click it üòâ</li>\n      <li class="features__item--X99Hrlr0C">Update ${q()}'s name and color</li>\n      <li class="features__item--X99Hrlr0C">Delete ${q()} or entire page with ${q()}s</li>\n      <li class="features__item--X99Hrlr0C">Generate a hundred of random ${q()}s in one click</li>\n      <li class="features__item--X99Hrlr0C">Navigate through the pages</li>\n      <li class="features__item--X99Hrlr0C">Test ${q()} in run-mode</li>\n      <li class="features__item--X99Hrlr0C">Start/reset race for current page</li>\n      <li class="features__item--X99Hrlr0C">The winner ${q()} of the race goes to the Records Tab</li>\n      <li class="features__item--X99Hrlr0C">You can sort winners by time or wins-count</li>\n      <li class="features__item--X99Hrlr0C">Tired of describing, maybe I forgot to mention something... üòÖ</li>\n    </ul>\n  </div>\n`},k={id:-1,name:"",color:_()},W=[[R.LEG_TIME,"500ms"],[R.EYE_TIME,"3s"],[R.EYE_DELAY,"0"],[R.BODY_TIME,"500ms"],[R.BODY_DELAY,"0"]];class V extends n{carModel=new S(k,null);carView=new L(this.carModel,!1,[C,"big-bug--3Zi2MzUCw"]);bugLayer=i("bug-layer--2seF1d65S");constructor(){super("root--c61vLnLAD"),this.build(),this.init()}build(){const t=i("content--2R78FQQjM"),e=a(G.title),s=a(G.greet),n=a(G.remind),r=a(G.features);t.append(s,n,r),this.bugLayer.append(this.carView.getRoot()),this.root.append(e,t,this.bugLayer)}init(){this.carModel.onUpdate=t=>this.carView.update(t),this.carModel.onDrive=t=>this.carView.applyCarModelState(t),this.carView.setCssState(C,!0),W.forEach((([t,e])=>{this.carView.setCssVar(t,e)}))}show(){this.setCssState(x,!1)}hide(){this.setCssState(x,!0)}}let Y,B,$;!function(t){t.CREATE="Create <BUG>",t.UPDATE="Update <BUG>",t.GENERATE="generate 100 <BUG>",t.REMOVE_PAGE="remove page",t.RACE="race",t.RESET="reset"}(Y||(Y={}));class H{listenersMap=new Map;addListener(t,e){this.listenersMap.has(t)||this.listenersMap.set(t,[]),this.listenersMap.get(t)?.push(e)}removeListener(t,e){this.listenersMap.get(t)?.filter((t=>t!==e))}notify(t,e){this.listenersMap.get(t)?.forEach((t=>t(e)))}reset(){this.listenersMap.forEach((t=>{t.length=0})),this.listenersMap.clear()}}!function(t){t.UPDATED="updated"}(B||(B={})),function(t){t.NEXT="next",t.PREV="prev",t.REQUEST_PAGE="request page",t.BEFORE_REQUEST="before request",t.PAGE_UPDATED="page updated"}($||($={}));class F{pageObserver=new H;totalCount=0;pageNum=1;constructor(t){this.pageLimit=t}pageUpdate(t,e){this.totalCount=t,void 0!==e&&(this.pageNum=e),this.pageObserver.notify(B.UPDATED,this)}onPageUpdate(t){this.pageObserver.addListener(B.UPDATED,t)}getPage(t){const{num:e}=t?this.getNext():this.getPrev();return e}getNext(){const t=this.totalCount-this.pageNum*this.pageLimit>0;return{num:this.pageNum+1,enabled:t}}getPrev(){const t=this.pageNum>1;return{num:this.pageNum-1,enabled:t}}}const X="http://127.0.0.1:3000";let j,K;!function(t){t.GET="GET",t.POST="POST",t.PUT="PUT",t.DELETE="DELETE"}(j||(j={})),function(t){t.GARAGE="/garage",t.ENGINE="/engine",t.WINNERS="/winners"}(K||(K={}));const J="X-Total-Count";let Q,Z,z,tt,et,st;function it(t,e){return t instanceof Object?e(t):null}function at(t,e){return Array.isArray(t)?t.map((t=>e(t))).filter((t=>null!==t)):[]}function nt(t){return at(t,ot)}function rt(t){return at(t,ht)}function ot(t){return it(t,(t=>"number"==typeof t.id&&"string"==typeof t.name&&"string"==typeof t.color?t:null))}function ht(t){return it(t,(t=>"number"==typeof t.id&&"number"==typeof t.wins&&"number"==typeof t.time?t:null))}function ct(t){return it(t,(t=>"number"==typeof t.velocity&&"number"==typeof t.distance?t:null))}function lt(t){return it(t,(t=>"boolean"==typeof t.success?t:null))}!function(t){t.PAGE="_page",t.LIMIT="_limit",t.SORT="_sort",t.ORDER="_order"}(Q||(Q={})),function(t){t.ID="id",t.STATUS="status"}(Z||(Z={})),function(t){t.STARTED="started",t.STOPPED="stopped",t.DRIVE="drive"}(z||(z={})),function(t){t.ID="id",t.WINS="wins",t.TIME="time"}(tt||(tt={})),function(t){t.INITIAL="initial",t.ASC="ASC",t.DESC="DESC"}(et||(et={})),function(t){t.USER_ABORT="4242",t.OK="200",t.BAD_REQUEST="400",t.NOT_FOUND="404",t.TOO_MANY_REQUESTS="429",t.INTERNAL_SERVER_ERROR="500"}(st||(st={}));class dt extends Error{constructor(){super("User interrupt REST API action")}}class ut extends Error{constructor(t){super(`\n${t.url}\n${t.status} ${t.statusText}\n${t.type}`)}}class pt extends ut{}class gt extends Error{constructor(t){super(`\n${t}\n${X}`)}}class mt extends Error{constructor(t){super(`Parse JSON Error: ${t}`)}}function Et(t,e={}){return`${X}${t}?${function(t){return Object.entries(t).map((([t,e])=>`${t}=${e}`)).join("&")}(e)}`}function wt(t=j.GET,e,s){const i={method:t};return i.headers=new Headers,e&&(i.body=JSON.stringify(e),i.headers.append("content-type","application/json")),s&&(i.signal=s),i}const Rt=t=>wt(j.GET,void 0,t),St=(t,e)=>wt(j.POST,t,e),bt=(t,e)=>wt(j.PUT,t,e),Tt=t=>wt(j.DELETE,void 0,t),Ct=(t=200)=>e=>{if(e.status===t)return null;switch(e.status){case 500:return new pt(e);default:return new ut(e)}};async function vt({statusHandler:t=Ct(),url:e,init:s=Rt()}){let i;try{i=await fetch(e,s)}catch(t){return t instanceof Error?t instanceof DOMException&&"AbortError"===t.name?new dt:new gt(t.message):null}return t(i)||i}async function ft(t,e){let s;try{s=await t.json()}catch(t){return t instanceof Error?new mt(t.message):null}return e(s)}async function yt({validator:t,...e}){const s=await vt(e);return s instanceof Response?ft(s,t):s}async function At(t,e){const s=await vt(((t,e=7)=>({url:Et(K.GARAGE,{[Q.PAGE]:t,[Q.LIMIT]:e})}))(t,e));if(!(s instanceof Response))return s;const i=Number(s.headers.get(J))||0,a=await ft(s,nt);return Array.isArray(a)?{carDTOArray:a,totalCount:i||a.length}:a}async function Mt(t){return yt({url:Et(`${K.GARAGE}/${t}`),init:Tt(),validator:()=>!0})}async function It({id:t,name:e,color:s}){return yt({url:Et(`${K.GARAGE}/${t}`),init:bt({name:e,color:s}),validator:ot})}const Pt=(t,e)=>Et(K.ENGINE,{[Z.ID]:t,[Z.STATUS]:e});async function Dt(t){return yt({url:Pt(t,z.STOPPED),validator:ct})}async function Nt(t){return yt({url:Et(`${K.WINNERS}/${t}`),init:Tt(),validator:()=>!0})}class Ot extends F{cars=new Array;constructor(){super(7)}updateCars(t){this.cars=t.map((t=>new S(t,null))),this.onCarsUpdate?.(this.cars)}add(t){if(this.cars.length>=this.pageLimit)return null;const e=new S(t,null);return this.cars.push(e),e}remove(t){this.cars=this.cars.filter((e=>e!==t))}}let Lt;!function(t){t.SUBMIT="submit",t.CANCEL="cancel"}(Lt||(Lt={}));const Ut={id:-1,name:"",color:"#ff0000"},_t="input--38R6rOD8V";class xt extends n{nameInput=i([_t,"name--3QARSEVUN"],{tag:"input"});colorInput=i([_t,"color--1YrZ6BIOM"],{tag:"input"});btnSubmit=new c(Lt.SUBMIT);btnCancel=new c(Lt.CANCEL);carView=new L(null,!0,["big-bug--2axAn4xy8"]);constructor(t,e=Ut){super("root--2ikLv1NXE"),this.initialCarDTO=e,this.btnSubmit.update(t),this.build(),this.init(),this.initBinds()}build(){const t=i("inputs-wrapper--3kVZYxvit"),e=i("btns-wrapper--2dayAGJH1"),s=i("car-wrapper--1YRszKyZb");t.append(this.nameInput,this.colorInput),e.append(this.btnSubmit.getRoot(),this.btnCancel.getRoot()),s.append(this.carView.getRoot()),this.root.append(t,s,e)}init(){this.nameInput.type="text",this.colorInput.type="color",this.nameInput.value=this.initialCarDTO.name,this.colorInput.value=this.initialCarDTO.color,this.carView.applayDTO(this.carDTO)}initBinds(){this.btnSubmit.onClick((()=>this.submit())),this.btnCancel.onClick((()=>this.cancel())),this.nameInput.addEventListener("input",(()=>this.inputHandler())),this.colorInput.addEventListener("input",(()=>this.inputHandler())),this.inputHandler(),this.btnSubmit.disable()}get carDTO(){return{id:this.initialCarDTO.id,name:this.nameInput.value,color:this.colorInput.value}}inputHandler(){this.carView.applayDTO(this.carDTO),this.btnSubmit.switch(!!this.nameInput.value)}submit(){this.onSubmit&&this.onSubmit(this.carDTO)}cancel(){this.reset(),this.onCancel?.(),this.btnSubmit.disable()}reset(){this.nameInput.value=this.initialCarDTO.name,this.colorInput.value=this.initialCarDTO.color,this.carView.applayDTO(this.initialCarDTO)}}let qt,Gt;!function(t){t.SELECT="select",t.REMOVE="remove",t.START="A",t.STOP="B"}(qt||(qt={})),function(t){t.INITIAL="initial",t.DRIVE="drive",t.EMPTY="empty"}(Gt||(Gt={}));class kt extends n{place=i("place--286rjQUvG",{tag:"span"});time=i("time--g15Cs9mkn",{tag:"span"});name=i("name--3r1CtiLm4",{tag:"span"});constructor(t){super(["info--3b__Yk0cs",t]),this.build()}build(){this.root.append(this.place,this.time,this.name)}reset(t){this.place.textContent="",this.time.textContent="",this.name.textContent=t?.name||""}update(t,e){this.place.textContent=`${t}`,this.time.textContent=`${e.time}s`,this.name.textContent=e.name}}const Wt="show-info--YFHRIKaFY",Vt="place1--10jpx9J-K",Yt="place2--1rFtSepIs",Bt="place3--21YUMCJbE",$t="neon--18KkGJN7J";class Ht extends n{stateMap=new Map;btnStart=new c(qt.START,h.START);btnStop=new c(qt.STOP,h.STOP);track=i("track--e7Dibkwqx");name=i("name--3qJqlJZw_");info=new kt("info--3ujLU1IUQ");carModel=null;carView=new L(this.carModel);constructor(){super("root--3YCL6Wxhy"),this.build(),this.init(),this.initStateMap(),this.reset()}get buttons(){return[this.btnStart,this.btnStop]}build(){const t=i("btns-wrapper--9-sNwqyKG");t.append(...this.buttons.map((t=>t.getRoot()))),this.root.append(t);const e=i("body--2Ww2DFNF7");e.append(this.track),this.track.append(this.name,this.info.getRoot(),this.carView.getRoot()),this.root.append(t,e)}init(){this.btnStart.onClick((()=>this.start())),this.btnStop.onClick((()=>this.stop())),this.carView.onSelect=()=>this.onSelect?.(this.carModel),this.carView.onRequestUpdate=()=>this.requestUpdate(),this.carView.onRequestRemove=()=>this.requestRemove(),this.setCssState(Wt,!1)}initStateMap(){this.stateMap.set(Gt.INITIAL,(()=>this.toInitialState())),this.stateMap.set(Gt.DRIVE,(()=>this.toRunState())),this.stateMap.set(Gt.EMPTY,(()=>this.toEmptyState()))}deselect(){this.carView.deselect()}requestUpdate(){this.carModel&&this.onRequestUpdate&&this.onRequestUpdate?.(this.carModel)}async requestRemove(){this.carModel&&this.onRequestRemove&&(this.switch(Gt.EMPTY),await(this.onRequestRemove?.(this.carModel)),this.switch(Gt.INITIAL))}async start(){this.carModel&&this.onStart&&(this.switch(Gt.DRIVE),await(this.onStart?.(this.carModel)))}async stop(){this.carModel&&this.onStop&&(await(this.onStop?.(this.carModel)),this.switch(Gt.INITIAL))}reset(){this.carModel?.reset(),this.carModel=null,this.name.textContent="",this.carView.update(null),this.switch(Gt.EMPTY)}update(t){t!==this.carModel&&(t?(this.carModel=t,t.onUpdate=t=>{this.updateName(t),this.carView.update(t)},t.onDrive=t=>this.carView.applyCarModelState(t),this.updateName(t),this.carView.update(t),this.switch(Gt.INITIAL)):this.reset())}updateName(t){this.name.textContent=t.name}switch(t=Gt.INITIAL){this.stateMap.get(t)?.()}toInitialState(){this.btnStart.switch(!0),this.btnStop.switch(!1),this.setCssState(Wt,!1),this.show()}toRunState(){this.btnStart.switch(!1),this.btnStop.switch(!0)}toEmptyState(){this.btnStart.switch(!1),this.btnStop.switch(!1)}show(t){if(t&&this.carModel)switch(this.info.update(t,this.carModel),this.setCssState(Wt,!0),t<4&&this.setCssState($t,!0),t){case 1:this.setCssState(Vt,!0);break;case 2:this.setCssState(Yt,!0);break;case 3:this.setCssState(Bt,!0)}else this.info.reset(this.carModel),this.setCssState(Wt,!1),this.setCssState($t,!1),this.setCssState(Vt,!1),this.setCssState(Yt,!1),this.setCssState(Bt,!1)}}const Ft="hidden--jDoXiAnxY",Xt="btn--3D25ZFKe5";class jt extends n{pageObserver=new H;pageNum=i("pageNum--2WgljGFm5");btnPrev=new c("",h.PREV,[Xt,"prev--o1TN36U8J"]);btnNext=new c("",h.NEXT,[Xt,"next--IG9NPUYZF"]);content=i("content--1usPoktt9");constructor(t,e,s="",i){super(["page--1-RUClzwv",s]),this.pageModel=t,this.pageName=e,this.popup=i,this.pageName=e,this.buildPage(),this.initPageBinds(),this.updatePage(t)}buildPage(){const t=i("paginatorWrapper--2oOQIiBfP"),e=i("paginator--1ykrOWiyU");e.append(this.btnPrev.getRoot(),this.pageNum,this.btnNext.getRoot()),t.append(e),this.root.append(this.content,t)}initPageBinds(){this.btnPrev.onClick((()=>this.requestPage($.PREV))),this.btnNext.onClick((()=>this.requestPage($.NEXT))),this.btnPrev.disable(),this.btnNext.disable()}updatePage(t){this.pageModel||(this.pageModel=t),this.btnPrev.switch(this.pageModel.getPrev().enabled),this.btnNext.switch(this.pageModel.getNext().enabled),this.pageNum.textContent=`Page #${t.pageNum}`,this.pageObserver.notify($.PAGE_UPDATED,`${this.pageName} (${t.totalCount})`)}requestPage(t){this.hookRequestPage?.(),this.pageObserver.notify($.REQUEST_PAGE,this.pageModel.getPage(t===$.NEXT))}onRequestPage(t){this.pageObserver.addListener($.REQUEST_PAGE,t)}onPageUpdated(t){this.pageObserver.addListener($.PAGE_UPDATED,t)}show(){this.setCssState(Ft,!1)}hide(){this.setCssState(Ft,!0)}}const Kt="btns-wrapper--DH0_EuQRl",Jt="btn--3UHd_-cag",Qt="btn-race--32syQCpMr";class Zt extends jt{btnAddCar=new c(Y.CREATE,h.DEFAULT,Jt);btnGenerate=new c(Y.GENERATE,h.DEFAULT,Jt);btnRemovePage=new c(Y.REMOVE_PAGE,h.DEFAULT,Jt);btnStartRace=new c(Y.RACE,h.START,Qt);btnResetRace=new c(Y.RESET,h.STOP,Qt);tracks=Array.from({length:7},(()=>new Ht));constructor(t,e){super(t,"Garage","garage--lig70blrd",e),this.build(t),this.initBinds()}get buttons(){return[this.btnAddCar,this.btnGenerate,this.btnRemovePage]}build(t){const e=i("controls--2p0bK3ztP"),s=i([Kt,"btns-car--3-BJvWomw"]),a=i([Kt,"btns-race--2X1QdEwdD"]),n=i("tracks--3k4uu0-4_");e.append(s,a),this.content.append(e,n),s.append(...this.buttons.map((t=>t.getRoot()))),a.append(this.btnStartRace.getRoot(),this.btnResetRace.getRoot()),n.append(...this.tracks.map((t=>t.getRoot()))),this.tracks.forEach(((e,s)=>e.update(t.cars[s])))}initBinds(){this.btnAddCar.onClick((()=>this.requestAddCar())),this.btnGenerate.onClick((()=>this.requestGenerateCars())),this.btnRemovePage.onClick((()=>this.requestRemovePage())),this.btnStartRace.onClick((()=>this.requestStartRace())),this.btnResetRace.onClick((()=>this.requestResetRace())),this.btnResetRace.disable(),this.tracks.forEach((t=>this.bindTrack(t)))}requestAddCar(){const t=new xt(Y.CREATE);t.onSubmit=t=>this.submitAddCar(t),this.popup.render(Y.CREATE,t.getRoot())}requestUpdateCar(t){if(!t)return;const e=new xt(Y.UPDATE,t.carDTO);e.onSubmit=t=>this.submitUpdateCar(t),this.popup.render(Y.UPDATE,e.getRoot())}async requestRemoveCar(t){t&&this.onRequestRemoveCar&&await(this.onRequestRemoveCar?.(t))}bindTrack(t){t.onSelect=()=>this.select(t),t.onRequestUpdate=t=>this.requestUpdateCar(t),t.onRequestRemove=t=>this.requestRemoveCar(t),t.onStart=t=>this.requestStartCar(t),t.onStop=t=>this.requestStopCar(t)}select(t){t.carModel&&this.tracks.filter((e=>e!==t)).forEach((t=>t.deselect()))}deselect(){this.tracks.forEach((t=>t.deselect()))}hookRequestPage=()=>{this.deselect(),this.tracks.forEach((t=>t.show()))};requestRemovePage=()=>{this.deselect(),this.onRequestRemovePage?.()};updateCars(t){this.tracks.forEach(((e,s)=>e.update(t[s]))),this.btnStartRace.enable(),this.btnResetRace.disable()}handleError(t){this.popup.showText(t.name,t.message)}showFinisher(t,e){this.tracks.find((t=>t.carModel===e))?.show(t)}getCarTracks(){return this.tracks.filter((t=>null!==t.carModel))}addCar(t){t&&this.tracks.find((t=>null===t.carModel))?.update(t)}async submitAddCar(t){this.addCar(await(this.onRequestAddCar?.(t))),await this.popup.hide()}async submitUpdateCar(t){await(this.onRequestUpdateCar?.(t)),await this.popup.hide()}async requestGenerateCars(t=100){const e=await(this.onRequestGenerateCars?.(t));e&&e.forEach((t=>this.addCar(t)))}async requestStartCar(t){t&&this.onRequestStartCar&&(this.btnResetRace.enable(),await(this.onRequestStartCar?.(t)))}async requestStopCar(t){t&&this.onRequestStopCar&&await(this.onRequestStopCar?.(t))}async requestStartRace(){this.tracks.forEach((t=>t.show())),this.btnStartRace.disable(),this.btnRemovePage.disable(),this.btnResetRace.enable(),this.getCarTracks().forEach((t=>t.switch(Gt.DRIVE)));const t=await(this.onRequestStartRace?.());t&&0!==t.length&&(this.btnStartRace.enable(),this.btnRemovePage.enable())}async requestResetRace(){this.tracks.forEach((t=>t.show())),this.btnStartRace.disable(),this.btnResetRace.disable(),this.btnRemovePage.disable(),this.getCarTracks().forEach((t=>t.switch(Gt.EMPTY))),await(this.onRequestResetRace?.()),this.getCarTracks().forEach((t=>t.switch(Gt.INITIAL))),this.btnStartRace.enable(),this.btnRemovePage.enable()}}class zt{constructor(t,e,s,i){this.model=t,this.view=e,this.carsService=s,this.raceService=i,this.initSimpleBinds(),this.initHeavyBinds(),this.initRaceBinds(),this.carsService.onError((t=>this.view.handleError(t)))}async init(){await this.carsService.init(),await this.carsService.getGaragePage()}initSimpleBinds(){this.model.onPageUpdate((t=>this.view.updatePage(t))),this.model.onCarsUpdate=t=>this.view.updateCars(t),this.view.onRequestAddCar=t=>this.carsService.addCar(t),this.view.onRequestUpdateCar=t=>this.carsService.updateCar(t),this.view.onRequestGenerateCars=t=>this.carsService.generateRandomBugs(t)}initHeavyBinds(){this.view.onRequestPage((async t=>{await this.raceService.resetRace(),await this.carsService.getGaragePage(t)})),this.view.onRequestRemoveCar=async t=>{await this.raceService.resetRace(),await this.carsService.removeCar(t.id)},this.view.onRequestRemovePage=async()=>{await this.raceService.resetRace(),await this.carsService.removeGaragePage()}}initRaceBinds(){this.view.onRequestStartCar=t=>this.raceService.startAndDrive(t),this.view.onRequestStopCar=t=>this.raceService.stop(t),this.view.onRequestStartRace=()=>this.raceService.startRace(),this.view.onRequestResetRace=()=>this.raceService.resetRace(),this.raceService.onFinish=(t,e)=>this.view.showFinisher(t,e)}}class te extends F{cars=new Array;constructor(){super(10)}updateWinners(t){this.cars=t,this.onWinnersUpdate?.(t)}get(t){return this.cars.find((e=>e.id===t))||null}add(t){return this.cars.length>=this.pageLimit?null:(this.cars.push(t),t)}remove(t){this.cars=this.cars.filter((e=>e.id!==t))}}let ee;!function(t){t.EMPTY="empty",t.RECORD="record"}(ee||(ee={}));const se="cell--3ZCUeOz9o",ie="hidden--3_lrTaEiE";class ae extends n{num=i([se,"num--2DSDYQECm"],{tag:"td"});car=i([se,"car---gj69PBty"],{tag:"td"});name=i([se,"name--1xRhVyghP"],{tag:"td"});wins=i([se,"wins--1fYmMC0vf"],{tag:"td"});time=i([se,"time--3y3JBYlmw"],{tag:"td"});state=ee.EMPTY;carView=new L(null,!0,["small-bug--1v897lR0a"]);get isEmpty(){return this.state===ee.EMPTY}constructor(t,e=null){super(["row--3P946rTeU"],{tag:"tr"}),this.build(),e&&this.update(t,e)}build(){this.car.append(this.carView.getRoot()),this.root.append(this.num,this.car,this.name,this.wins,this.time),this.reset()}update(t,e){if(t&&(this.num.textContent=t.toString()),!e)return void this.reset();const{name:s,wins:i,winTime:a}=e;this.state=ee.RECORD,this.carView.applayDTO(e.carDTO),this.car.classList.remove(ie),this.name.textContent=s,this.wins.textContent=`${i}`,this.time.textContent=`${a}`,e.onUpdate=e=>this.update(t,e)}reset(){this.state=ee.EMPTY,this.car.style.backgroundColor="",this.name.textContent="",this.wins.textContent="",this.time.textContent="",this.car.classList.add(ie)}}let ne;!function(t){t.NUM="number",t.CAR="car",t.NAME="name",t.WINS="wins",t.TIME="best time (seconds)"}(ne||(ne={}));const re="cell--1zHUNsJgP",oe="order--3yu3TXjNR",he="asc--X9AJEfqn5",ce="desc--iKM3kpfJF";function*le(){for(;;)yield et.INITIAL,yield et.ASC,yield et.DESC}function de(t,e){const s=e.next().value;switch(s){case et.ASC:t.classList.toggle(he,!0),t.classList.toggle(ce,!1);break;case et.DESC:t.classList.toggle(he,!1),t.classList.toggle(ce,!0);break;default:t.classList.toggle(he,!1),t.classList.toggle(ce,!1)}return s}class ue extends n{num=i([re,"num--3dLS6FoX2"],{tag:"th"});car=i([re,"car--3AvyL9IuL"],{tag:"th"});name=i([re,"name--1ouHT7BM1"],{tag:"th"});wins=i([re,"wins--3Q6W2f8p2",oe],{tag:"th"});time=i([re,"time--2E-Kuva0h",oe],{tag:"th"});winsOrderGenerator=le();timeOrderGenerator=le();winsOrder=this.winsOrderGenerator.next().value;timeOrder=this.timeOrderGenerator.next().value;constructor(){super("row--N8ysXnC-k",{tag:"tr"}),this.init()}init(){this.num.textContent=ne.NUM,this.car.textContent=ne.CAR,this.name.textContent=ne.NAME,this.wins.textContent=ne.WINS,this.time.textContent=ne.TIME,this.root.append(this.num,this.car,this.name,this.wins,this.time),this.wins.onclick=()=>this.requestSortWins(),this.time.onclick=()=>this.requestSortTime()}requestSortWins(){for(this.winsOrder=de(this.wins,this.winsOrderGenerator);this.timeOrder!==et.INITIAL;)this.timeOrder=de(this.time,this.timeOrderGenerator);this.onRequesSortWins?.(this.winsOrder)}requestSortTime(){for(this.timeOrder=de(this.time,this.timeOrderGenerator);this.winsOrder!==et.INITIAL;)this.winsOrder=de(this.wins,this.winsOrderGenerator);this.onRequesSortTime?.(this.timeOrder)}}class pe extends jt{table=i("table--2sS3hJdly",{tag:"table"});thead=i("thead--an6y6sE6Z",{tag:"thead"});tbody=i("tbody--2ePEId-H4",{tag:"tbody"});header=new ue;winnerViews=Array.from({length:10},((t,e)=>new ae(e+1)));sortType=tt.ID;sortOrder=et.INITIAL;constructor(t,e){super(t,"Winners","winners--atLxZAxel",e),this.initWinners()}initWinners(){this.thead.append(this.header.getRoot()),this.tbody.append(...this.winnerViews.map((t=>t.getRoot()))),this.table.append(this.thead,this.tbody),this.content.append(this.table),this.header.onRequesSortWins=t=>this.requesSortWins(t),this.header.onRequesSortTime=t=>this.requesSortTime(t)}requesSortWins(t){this.sortType=tt.WINS,this.sortOrder=t,this.onRequesSortWins?.(this.sortOrder)}requesSortTime(t){this.sortType=tt.TIME,this.sortOrder=t,this.onRequesSortTime?.(this.sortOrder)}handleError(t){this.popup.showText(t.name,t.message)}updateWinners(t){const e=this.pageModel.pageNum;this.winnerViews.forEach(((s,i)=>s.update(10*(e-1)+1+i,t[i])))}add(t){this.winnerViews.find((t=>t.isEmpty))?.update(null,t)}}class ge{constructor(t,e,s,i){this.model=t,this.view=e,this.carsService=s,this.raceService=i,this.initBinds()}init(){return this.carsService.getWinnersPage()}initBinds(){this.carsService.onError((t=>this.view.handleError(t))),this.model.onPageUpdate((t=>this.view.updatePage(t))),this.model.onWinnersUpdate=t=>this.view.updateWinners(t),this.raceService.onRaceWin((t=>this.carsService.addWinner(t))),this.carsService.onAddWinner=t=>this.view.add(t),this.view.onRequestPage((t=>this.carsService.getWinnersPage(t,this.view.sortType,this.view.sortOrder))),this.view.onRequesSortWins=t=>this.carsService.sortWins(t),this.view.onRequesSortTime=t=>this.carsService.sortTime(t)}}const me=function(){let t;return async()=>{if(!t){const e=await fetch("./dataset/us-car-models-2020-brands.json");t=await e.json()}return t}}(),Ee=["Evil","Bad","Stupid","Silly","Dumb","Crazy","Naive","Slow","Silent","Big","Heavy","Small","Little","Illegal","Abstract","Virtual","Unknown","Unexpected","Empty","Duplicate","Invalid","Missing","¬≠Corrupted¬≠","General¬≠","Native","Unsupported¬≠"],we=["I¬≠O","Internal","Access¬≠","Control","Locale¬≠","Range","Reference","Export","Import","Date","Time","Syntax","Type","Style","Linter","¬≠Parse","Reflection","Connection¬≠","Runtime","Arithmetic¬≠","Assertion¬≠","Cast","URI","Stream","Protocol","Format¬≠","Security¬≠","¬≠Operation","Read","Write","State","Server","Initializer","Verify","Promise","Event","Generator","Iterator","Memory","Stack","Service","Concurrent","Timeout¬≠"],Re=["Bug","Error","Warning","Exception","Fail","Failure","Halt","Abort","Break","Alert","Interrupt","Overflow","Reject","Fault","Damage","Crash","Glitch"];function Se(t){const e=U(0,t.length-1),s=U(0,t[e].models.length-1);return`${t[e].brand} ${t[e].models[s]}`}function be(){const t=U(0,Ee.length-1),e=U(0,we.length-1),s=U(0,Re.length-1);return`${Ee[t]} ${we[e]} ${Re[s]}`}function Te(t=100){return Array.from({length:t},(()=>({id:-1,name:be(),color:_()})))}function Ce(t){return null===t||t instanceof Error?null:t}function ve(t,e){return null===t?null:t instanceof Error?t:e(t)}function fe(t,e,s){return null===t?null:t instanceof Error?(s(t),null):e(t)}var ye;!function(t){t[t.ERROR=0]="ERROR"}(ye||(ye={}));class Ae{observer=new H;constructor(t,e){this.garageModel=t,this.winnersModel=e}async init(){const t=await At(this.garageModel.pageNum,this.garageModel.pageLimit);await ve(t,(async({carDTOArray:t,totalCount:e})=>{if(4===e&&4===(s=t).length&&(({id:t,name:e,color:s})=>1===t&&"Tesla"===e&&"#e6e6fa"===s)(s[0])&&(({id:t,name:e,color:s})=>2===t&&"BMW"===e&&"#fede00"===s)(s[1])&&(({id:t,name:e,color:s})=>3===t&&"Mersedes"===e&&"#6c779f"===s)(s[2])&&(({id:t,name:e,color:s})=>4===t&&"Ford"===e&&"#ef3c40"===s)(s[3])){const t=Te(4);t.forEach(((t,e)=>{t.id=e+1})),await Promise.all(t.map((t=>It(t))))}var s}))}async getGaragePage(t){fe(await At(t||this.garageModel.pageNum,this.garageModel.pageLimit),(({carDTOArray:e,totalCount:s})=>{this.garageModel.pageUpdate(s,t||this.garageModel.pageNum),this.garageModel.updateCars(e)}),(t=>this.noifyError(t)))}async getWinnersPage(t,e,s){const i=await async function(t,e,s,i){const a=await vt(((t,e=10,s=tt.ID,i=et.ASC)=>({url:Et(K.WINNERS,{[Q.PAGE]:t,[Q.LIMIT]:e,[Q.SORT]:s,[Q.ORDER]:i})}))(t,e,s,i));if(!(a instanceof Response))return a;const n=Number(a.headers.get(J))||0,r=await ft(a,rt);return Array.isArray(r)?{winDTOArray:r,totalCount:n||r.length}:r}(t||this.winnersModel.pageNum,this.winnersModel.pageLimit,e,s);await fe(i,(async({winDTOArray:e,totalCount:s})=>{this.winnersModel.pageUpdate(s,t||this.winnersModel.pageNum);const i=(await Promise.all(e.map((async t=>{const e=Ce(await async function(t){return yt({url:Et(`${K.GARAGE}/${t}`),validator:ot})}(t.id));return new S(e,t)})))).filter((t=>null!==t&&!(t instanceof Error)));this.winnersModel.updateWinners(i)}),(t=>this.noifyError(t)))}sortWins(t){return t===et.INITIAL?this.getWinnersPage():this.getWinnersPage(this.winnersModel.pageNum,tt.WINS,t)}sortTime(t){return t===et.INITIAL?this.getWinnersPage():this.getWinnersPage(this.winnersModel.pageNum,tt.TIME,t)}async addCar(t){const e=Ce(await async function({name:t,color:e}){return yt({url:Et(K.GARAGE),init:St({name:t,color:e}),statusHandler:Ct(201),validator:ot})}(t));return e?(this.garageModel.pageUpdate(this.garageModel.totalCount+1),this.garageModel.add(e)):null}async updateCar(t){const e=this.garageModel.cars.find((e=>e.id===t.id));e&&ve(await It(t),(t=>{e.update(t),this.winnersModel.cars.find((e=>e.id===t.id))?.update(t)}))}async generateRandomCars(t=100){const e=await function(t=100){return Promise.all(Array.from({length:t},(()=>async function(){return{id:-1,name:Se(await me()),color:_()}}())))}(t);return(await Promise.all(e.map((t=>this.addCar(t))))).filter((t=>null!==t))}async generateRandomBugs(t=100){const e=Te(t);return(await Promise.all(e.map((t=>this.addCar(t))))).filter((t=>null!==t))}async removeGaragePage(){const t=this.garageModel.cars.map((t=>Mt(t.id))),e=this.garageModel.cars.map((t=>Nt(t.id)));await Promise.all(t),await this.getGaragePage(),(await Promise.all(e)).find((t=>!0===t))&&await this.getWinnersPage()}async removeCar(t){await ve(await Mt(t),(async()=>{await Nt(t),this.garageModel.updateCars(this.garageModel.cars.filter((e=>e.id!==t))),this.winnersModel.updateWinners([]),await this.getGaragePage(),await this.getWinnersPage()}))}async addWinner(t){if(await this.updateWinner(t))return;const{id:e,time:s}=t,i=Ce(await async function(t){return yt({url:Et(K.WINNERS),init:St(t),statusHandler:Ct(201),validator:ht})}({id:e,wins:1,time:s}));if(!i)return;this.winnersModel.pageUpdate(this.winnersModel.totalCount+1),t.updateWin(i);const a=this.winnersModel.add(t);a&&this.onAddWinner?.(a)}async updateWinner(t){const{id:e,time:s}=t;let i=Ce(await async function(t){return yt({url:Et(`${K.WINNERS}/${t}`),validator:ht})}(t.id));if(!i)return!1;const{wins:a,time:n}=i;if(i=Ce(await async function({id:t,wins:e,time:s}){return yt({url:Et(`${K.WINNERS}/${t}`),init:bt({wins:e,time:s}),validator:ht})}({id:e,wins:a+1,time:Math.min(s,n)})),!i)return!1;const r=this.winnersModel.get(e);return r&&r.updateWin(i),!0}onError(t){this.observer.addListener(ye.ERROR,t)}noifyError(t){this.observer.notify(ye.ERROR,t)}}let Me;!function(t){t.PENDING="pending",t.FULFILLED="fulfilled",t.REJECTED="rejected"}(Me||(Me={}));class Ie{observer=new H;race=new Map;raceResults=[];raceStartTime=new Date;constructor(t,e){this.garageModel=t,this.winnersModel=e}abort(t){this.race.has(t)&&(this.race.get(t).abort(),this.race.delete(t))}async start(t){if(this.race.has(t))return;t.driveStart(10*(Math.random()+1));const e=Ce(await async function(t){return yt({url:Pt(t,z.STARTED),validator:ct})}(t.id));if(!e)return void t.driveReset();const{distance:s,velocity:i}=e;t.driveStart(Math.ceil(s/i)),this.race.set(t,new AbortController)}async stop(t){this.race.has(t)&&(this.abort(t),Ce(await Dt(t.id))&&t.driveReset())}stopSync(t){this.race.has(t)&&(this.abort(t),Dt(t.id),t.driveReset())}async drive(t){if(!this.race.has(t))return null;const e=this.race.get(t),s=(i=(t.duration||1e4)+10,a=e,new Promise((t=>setTimeout(t,i,a))));var i,a;const n=async function(t,e){return yt({url:Pt(t,z.DRIVE),init:Rt(e),validator:lt})}(t.id,e.signal);t.driveMove();const r=await Promise.race([s,n]);return null===r?null:r instanceof Error?(t.driveDead(),null):(r instanceof AbortController&&r.abort(),t.driveFinish(),t)}async startAndDrive(t){await this.start(t),await this.drive(t)}abortRace(){0!==this.race.size&&(this.raceResults=[],[...this.race.keys()].map((t=>this.abort(t))))}async resetRace(){this.race.size>0&&(this.raceResults=[],await Promise.all([...this.race.keys()].map((t=>this.stop(t)))))}resetRaceSync(){0!==this.race.size&&(this.raceResults=[],[...this.race.keys()].map((t=>this.stopSync(t))))}async startRace(){await this.resetRace(),await Promise.all(this.garageModel.cars.map((t=>this.start(t))));const t=this.garageModel.cars.map((t=>this.drive(t)));return this.raceResults=[],this.raceStartTime=new Date,await this.doRace(t),this.raceResults}async doRace(t){if(0===t.length)return;const e=t.map((t=>t.then((e=>({car:e,promise:t}))))),{car:s,promise:i}=await Promise.race(e);if(s){this.raceResults.push(s);const t=this.raceResults.length;1===t&&this.notifyRaceWin(s),this.onFinish?.(t,s)}await this.doRace(t.filter((t=>t!==i)))}onRaceWin(t){this.observer.addListener(g.RACE_WIN,t)}notifyRaceWin(t){this.observer.notify(g.RACE_WIN,t)}}class Pe extends n{btnToAbout=new c(s.ABOUT,h.ROUTE,t);btnToGarage=new c(s.GARAGE,h.ROUTE,t);btnToWinners=new c(s.WINNERS,h.ROUTE,t);aboutView=new V;constructor(t=s.ABOUT){super("app--hIZJ1RoMS"),this.build(),this.init(),this.update(t)}build(){const t=new d,e=new m(t),s=new Ot,n=new te,r=new Zt(s,e),o=new pe(n,e),h=new Ae(s,n),c=new Ie(s,n);this.carsController=new zt(s,r,h,c),this.winsController=new ge(n,o,h,c);const l=i("header--2RYU6WmLd",{tag:"header"}),u=i("wrapper--3uVR9_6_B");l.append(this.btnToAbout.getRoot(),this.btnToGarage.getRoot(),this.btnToWinners.getRoot()),u.append(this.aboutView.getRoot(),r.getRoot(),o.getRoot()),this.root.append(l,u,a('\n  <footer class="footer--1Vpt7TVyZ">\n    <div class="footer__wrapper--xx7cob4ia">\n      <a class="logo--6jXTxWm-a rss--32WyxUeSD" href="https://rs.school/js/">\n        <svg class="svg--1H42RH16p rss--32WyxUeSD">\n          <use href="./svg/sprite.svg#icon-rs-school-js"></use>\n        </svg>\n        <span class="text--3y91nhcxu rss--32WyxUeSD">\'21</span>\n      </a>\n      <div class="group--2lRZJ2xK8">\n        <a class="logo--6jXTxWm-a github--1S5KXahA4" href="https://github.com/dimonwhite">\n          <svg class="svg--1H42RH16p github--1S5KXahA4">\n            <use href="./svg/sprite.svg#icon-github"></use>\n          </svg>\n          <span class="text--3y91nhcxu github--1S5KXahA4">mentor<span class="spoiler--1dCvULlAA">: dimonwhite</span></span>\n        </a>\n        <a class="logo--6jXTxWm-a github--1S5KXahA4" href="https://github.com/fronte-finem">\n          <svg class="svg--1H42RH16p github--1S5KXahA4">\n            <use href="./svg/sprite.svg#icon-github"></use>\n          </svg>\n          <span class="text--3y91nhcxu github--1S5KXahA4">student<span class="spoiler--1dCvULlAA">: fronte-finem</span></span>\n        </a>         \n      </div>\n    </div>\n  </footer>\n')),this.root.append(t.getRoot(),e.getRoot())}init(){this.btnToAbout.onClick((()=>this.update(s.ABOUT))),this.btnToGarage.onClick((()=>this.update(s.GARAGE))),this.btnToWinners.onClick((()=>this.update(s.WINNERS))),this.carsController.view.onPageUpdated((t=>this.btnToGarage.update(t))),this.winsController.view.onPageUpdated((t=>this.btnToWinners.update(t)))}async start(){await this.carsController.init(),await this.winsController.init()}update(t){switch(t){case s.ABOUT:this.activate(this.aboutView,this.btnToAbout);break;case s.GARAGE:this.activate(this.carsController.view,this.btnToGarage);break;case s.WINNERS:this.activate(this.winsController.view,this.btnToWinners)}}get routerBtns(){return[this.btnToAbout,this.btnToGarage,this.btnToWinners]}get routerPages(){return[this.aboutView,this.carsController.view,this.winsController.view]}activate(t,s){t.show(),s.setCssState(e,!0),this.routerPages.filter((e=>e!==t)).forEach((t=>t.hide())),this.routerBtns.filter((t=>t!==s)).forEach((t=>t.setCssState(e,!1)))}}window.addEventListener("load",(async()=>{const t=new Pe;document.body.classList.add("root--3pk7p9P8N"),document.body.append(t.getRoot()),await t.start()}))})();