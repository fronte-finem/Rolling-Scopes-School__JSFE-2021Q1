(()=>{"use strict";const t="btn--2WpXrPgI1",e="active--2tNpRN1xk";let s;!function(t){t.ABOUT="about",t.GARAGE="garage",t.WINNERS="winners"}(s||(s={}));function i(t,{tag:e="div",parent:s}={}){const i=document.createElement(e);return i.classList.add(...Array.isArray(t)?t:[t]),s&&s.append(i),i}function a(t){const e=document.createElement("template");return e.innerHTML=t,e.content.firstElementChild}class n{getRoot(){return this.root}constructor(t,e){this.root=i(t,e)}setCssState(t,e){this.root.classList.toggle(t,e)}setCssStateAsync(t,e){return this.root.classList.toggle(t,e),new Promise((t=>{this.root.addEventListener("transitionend",(()=>t()),{once:!0})}))}getCssVar(t){return function(t,e){return getComputedStyle(t).getPropertyValue(e)}(this.root,t)}setCssVar(t,e){!function(t,e,s){t.style.setProperty(e,s)}(this.root,t,e)}setCssStyle(t,e){this.root.style[t]=e}onClick(t,e){this.root.addEventListener("click",t,e)}}const r={button:"button--191tdEwmU","btn-process":"btn-process--3IX__tdei",btnProcess:"btn-process--3IX__tdei",start:"start--1MJZ6TKsG",stop:"stop--3awnw9pRV","btn-no-text":"btn-no-text--2hGC24VAJ",btnNoText:"btn-no-text--2hGC24VAJ","btn-route":"btn-route--2IJsR23sR",btnRoute:"btn-route--2IJsR23sR","btn-paginator":"btn-paginator--hIA-wAZFL",btnPaginator:"btn-paginator--hIA-wAZFL",prev:"prev--1g6lHKdln",next:"next--N-4z3NFTi"};let o;!function(t){t.DEFAULT="default",t.START="start",t.STOP="stop",t.NEXT="next",t.PREV="prev",t.DELETE="delete",t.ROUTE="route"}(o||(o={}));class h extends n{constructor(t="",e=o.DEFAULT,s){super(((t=o.DEFAULT,e)=>{const s=(t=>{switch(t){case o.START:return[r.btnProcess,r.start];case o.STOP:return[r.btnProcess,r.stop];case o.NEXT:return[r.btnPaginator,r.next];case o.PREV:return[r.btnPaginator,r.prev];case o.DELETE:return[r.btnNoText,r.delete];case o.ROUTE:return[r.btnRoute];case o.DEFAULT:default:return[r.button]}})(t);return e?s.concat(Array.isArray(e)?e:[e]):s})(e,s),{tag:"button"}),this.update(t)}update(t){this.root.textContent=t}switch(t=!0){this.root.disabled=!t}enable(){this.switch()}disable(){this.switch(!1)}}let c;!function(t){t.HIDDEN="hidden",t.VISIBLE="visible"}(c||(c={}));class l extends n{constructor(){super("modal--3Df_I9THw"),this.hide()}update(t){const e=t===c.HIDDEN;this.setCssState("hidden--k9ZbS_xCi",e),document.body.classList.toggle("body-hidden--2oHUPUxwA",!e)}hide(){this.update(c.HIDDEN)}show(){this.update(c.VISIBLE)}}const d="hidden--My18nl3md";let u,p;!function(t){t.HIDDEN="hidden",t.VISIBLE="visible"}(u||(u={}));class m extends n{header=i("header--mxD9cbWG7",{tag:"header"});content=i("content--2SkI5oqgx");btnClose=new h("",o.DELETE,"btn-close--13xSSIKOb");constructor(t){super("popup--23aQaCACL"),this.modal=t,this.build(),this.initBinds()}build(){this.root.append(this.header,this.content,this.btnClose.getRoot()),this.setCssStateAsync(d,!0)}initBinds(){this.modal.onClick((()=>this.hide())),this.btnClose.onClick((()=>this.hide()))}showText(t,e){this.header.textContent=t,this.content.textContent=e,this.show()}render(t,e){this.header.textContent=t,this.content.append(e),this.show()}async hide(){this.modal.hide(),document.body.removeEventListener("keydown",this.escapeListener),await this.setCssStateAsync(d,!0),this.header.innerHTML="",this.content.innerHTML="",this.onHide?.()}show(){this.modal.show(),this.setCssState(d,!1),document.body.addEventListener("keydown",this.escapeListener,{once:!0}),this.onShow?.()}escapeListener=t=>{"Escape"===t.code&&this.hide()}}!function(t){t[t.GARAGE_ERROR=0]="GARAGE_ERROR",t[t.RACE_WIN=1]="RACE_WIN",t[t.RACE_END=2]="RACE_END",t[t.RACE_RESET=3]="RACE_RESET",t[t.START=4]="START",t[t.STOP=5]="STOP",t[t.EMPTY=6]="EMPTY"}(p||(p={}));const g="#000000";let E,w;!function(t){t.INITIAL="initial",t.START="start",t.STOP="stop",t.DRIVE="race",t.BROKEN="broken",t.FINISH="finish"}(E||(E={})),function(t){t.COLOR="--color1",t.POSITION="--position",t.LEG_TIME="--leg-time",t.EYE_TIME="--eye-time",t.EYE_DELAY="--eye-delay",t.BODY_TIME="--body-time",t.BODY_DELAY="--body-delay"}(w||(w={}));class b{id=-1;name="";color=g;state=E.INITIAL;position=0;wins=0;winTime=NaN;duration=null;get time(){return Number(((this.duration||NaN)/1e3).toFixed(2))}constructor(t,e){t&&(this.id=t.id,this.name=t.name,this.color=t.color),e&&(this.wins=e.wins,this.winTime=e.time)}get carDTO(){return{id:this.id,name:this.name,color:this.color}}reset(){this.id=-1,this.name="",this.color=g,this.position=0}update({name:t,color:e}){return this.name=t,this.color=e,this.onUpdate?.(this),this}updateWin({wins:t,time:e}){this.wins=t,this.winTime=e,this.onUpdate?.(this),this.onUpdateWin?.(this)}driveStart(t){return this.state=E.START,this.duration=t,this.onDrive?.(this),this}driveDead(){return this.state=E.BROKEN,this.onDrive?.(this),this}driveFinish(){return this.state=E.FINISH,this.onDrive?.(this),this}driveReset(){return this.state=E.INITIAL,this.position=0,this.onDrive?.(this),this}driveMove(){return this.duration?(this.state=E.DRIVE,this.onDrive?.(this),this.driveAnimate(this.duration),this):this}driveAnimate(t){let e=-1;const s=i=>{if(this.state!==E.DRIVE)return;-1===e&&(e=i);const a=i-e;this.position=100*Math.min(a/t,1),a<t&&window.requestAnimationFrame(s),this.onDrive?.(this)};window.requestAnimationFrame(s)}}const R="hidden--31Pvs2zLy",S="start--yZt0kpRva",T="run--3IccbmaHP",C="dead--29B1Oma7n",v="finish--_qQZE3gbP",f="eye--2q-OCopyB",y="leg--yfPjiDGFz",A="leg1--2bU_q-CeA",I="leg2--2m3WSNtgo",M="leg3--2ANXbS6-g",D="leg-left--xrFNpC8f0",P="leg-right--l5cToLYPo";class N extends n{stateMap=new Map;btnRemove=new h("",o.DELETE,"btn--UNu0CbLSC");carModel=null;constructor(t,e=!1,s=[]){super(["car--3rvQqyq8b",...s]),this.passive=e,this.build(),this.init(),this.initStateMap(),this.stateMap.get(E.INITIAL)?.(),this.update(t)}build(){const t=i([f,"eye--left--3_ASXcWDv"]),e=i([f,"eye--right--1P-CANYXq"]),s=i([y,D,A]),a=i([y,D,I]),n=i([y,D,M]),r=i([y,P,A]),o=i([y,P,I]),h=i([y,P,M]),c=i("body--3bgk0PFtN"),l=i("body__cover--1oichIJ96");c.append(s,a,n,r,o,h,l),l.append(t,e),this.root.append(c,this.btnRemove.getRoot()),this.setCssState("passive--v3Oixi1yG",this.passive)}selectTitle=()=>`Click to select: "${this.carModel?.name||""}"`;removeTitle=()=>`Click to delete: "${this.carModel?.name||""}"`;init(){this.onClick((()=>this.select(!0))),this.btnRemove.onClick((()=>this.remove()))}deselect=()=>{this.select(!1)};select(t=!0){this.setCssState("select--2hPNGdcnE",t),t&&this.onSelect&&this.onSelect()}remove(){this.onRemove&&(document.body.removeEventListener("click",this.deselect),this.select(!1),this.onRemove())}initStateMap(){this.stateMap.set(E.INITIAL,(()=>this.toInitialState())),this.stateMap.set(E.START,(()=>this.toStartState())),this.stateMap.set(E.DRIVE,(t=>this.toRunState(t))),this.stateMap.set(E.BROKEN,(()=>this.toDeadState())),this.stateMap.set(E.FINISH,(()=>this.toFinishState()))}toInitialState(){this.setCssState(R,!1),this.setCssState(S,!1),this.setCssState(T,!1),this.setCssState(C,!1),this.setCssState(v,!1),[[w.POSITION,"0%"],[w.LEG_TIME,`${1+Math.random()}s`],[w.EYE_TIME,"5s"],[w.EYE_DELAY,5*Math.random()+"s"],[w.BODY_TIME,`${2+Math.random()}s`],[w.BODY_DELAY,`${Math.random()}s`]].forEach((([t,e])=>{this.setCssVar(t,e)}))}toStartState(){this.setCssState(S,!0),[[w.LEG_TIME,`${Math.random()}s`],[w.EYE_TIME,"3s"],[w.EYE_DELAY,.2*Math.random()+"s"],[w.BODY_TIME,`${Math.random()}s`],[w.BODY_DELAY,.2*Math.random()+"s"]].forEach((([t,e])=>{this.setCssVar(t,e)}))}toRunState(t){var e;t?.position?this.setCssVar(w.POSITION,`${t.position}%`):(this.setCssState(S,!1),this.setCssState(T,!0),(e=(t?.duration||10)/10,[[w.LEG_TIME,`${e}ms`],[w.EYE_TIME,"3s"],[w.EYE_DELAY,`${Math.random()}s`],[w.BODY_TIME,2*e+"ms"],[w.BODY_DELAY,`${Math.random()}s`]]).forEach((([t,e])=>{this.setCssVar(t,e)})))}toDeadState(){this.setCssState(T,!1),this.setCssState(C,!0),[[w.LEG_TIME,"1s"],[w.EYE_TIME,"10s"],[w.EYE_DELAY,`${Math.random()}s`],[w.BODY_TIME,"5s"],[w.BODY_DELAY,`${Math.random()}s`]].forEach((([t,e])=>{this.setCssVar(t,e)}))}toFinishState(t){var e;this.setCssState(T,!1),this.setCssState(v,!0),(e=(t?.duration||10)/10,[[w.EYE_TIME,"5s"],[w.EYE_DELAY,`${Math.random()}s`],[w.BODY_TIME,2*e+"s"],[w.BODY_DELAY,`${Math.random()}s`]]).forEach((([t,e])=>{this.setCssVar(t,e)}))}update(t){this.carModel=t,this.passive||(this.root.title=this.selectTitle()),this.btnRemove.getRoot().title=this.removeTitle(),t?(this.setCssState(R,!1),this.setCssVar(w.COLOR,t.color)):this.setCssState(R,!0)}applayDTO(t){this.setCssVar(w.COLOR,t.color)}applyCarModelState(t){this.setCssState("btn-to-left--1dnVYq67J",t.position>50),this.stateMap.get(t.state)?.(t)}}function O(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function L(){const[t,e,s]=[O(0,359),Math.random(),Math.random()];return function(t,e,s){const[i,a,n]=function(t,e,s){const i=e*Math.min(s,1-s),a=(e,a=(e+t/30)%12)=>s-i*Math.max(Math.min(a-3,9-a,1),-1);return[a(0),a(8),a(4)]}(t,e,s);return function(t,e,s){return`#${[t,e,s].map((t=>Math.round(255*t).toString(16).padStart(2,"0"))).join("")}`}(i,a,n)}(t,e<.75?1-e:e,.5+(.5-s)/2)}const U="hidden--2hzuHT1QT",x=()=>`<span class="bug--1JLt3MKkB" style="--flicker-delay:${Math.random()}s; --color:${L()}">&lt;BUG&gt;</span>`,_={title:`<h1 class="title--NZB02zoMr">Async ${x()} Race</h1>`,greet:'\n  <h2 class="greet--1zKM1vpjn">Welcome fellow \n    <a class="link--1YAaTBu46" href="https://github.com/rolling-scopes-school/tasks/blob/master/tasks/async-race.md">async-racers</a>!\n   😁\n  </h2>',remind:'\n  <p class="remind--9fEr1pITO">To participate in the race, you need to start the\n    <a class="link--1YAaTBu46" href="https://github.com/mikhama/async-race-api">server</a>.\n  </p>',features:`\n  <div class="features--1FT35BRdy">\n    <h3 class="features__title--3-wDq14LN">Suported features:</h3>\n    <ul class="features__list--1ivKMakhr">\n      <li class="features__item--X99Hrlr0C">Create custom ${x()}</li>\n      <li class="features__item--X99Hrlr0C">For select ${x()} juct click it 😉</li>\n      <li class="features__item--X99Hrlr0C">Update ${x()}'s name and color</li>\n      <li class="features__item--X99Hrlr0C">Delete ${x()} or entire page with ${x()}s</li>\n      <li class="features__item--X99Hrlr0C">Generate a hundred of random ${x()}s in one click</li>\n      <li class="features__item--X99Hrlr0C">Navigate through the pages</li>\n      <li class="features__item--X99Hrlr0C">Test ${x()} in run-mode</li>\n      <li class="features__item--X99Hrlr0C">Start/reset race for current page</li>\n      <li class="features__item--X99Hrlr0C">The winner ${x()} of the race goes to the Records Tab</li>\n      <li class="features__item--X99Hrlr0C">You can sort winners by time or wins-count</li>\n      <li class="features__item--X99Hrlr0C">Tired of describing, maybe I forgot to mention something... 😅</li>\n    </ul>\n  </div>\n`},G={id:-1,name:"",color:L()},k=[[w.LEG_TIME,"500ms"],[w.EYE_TIME,"3s"],[w.EYE_DELAY,"0"],[w.BODY_TIME,"500ms"],[w.BODY_DELAY,"0"]];class W extends n{carModel=new b(G,null);carView=new N(this.carModel,!1,[T,"big-bug--3Zi2MzUCw"]);bugLayer=i("bug-layer--2seF1d65S");constructor(){super("root--c61vLnLAD"),this.build(),this.init()}build(){const t=i("content--2R78FQQjM"),e=a(_.title),s=a(_.greet),n=a(_.remind),r=a(_.features);t.append(s,n,r),this.bugLayer.append(this.carView.getRoot()),this.root.append(e,t,this.bugLayer)}init(){this.carModel.onUpdate=t=>this.carView.update(t),this.carModel.onDrive=t=>this.carView.applyCarModelState(t),this.carView.setCssState(T,!0),k.forEach((([t,e])=>{this.carView.setCssVar(t,e)}))}show(){this.setCssState(U,!1)}hide(){this.setCssState(U,!0)}}let q,V,Y;!function(t){t.ADD="add",t.UPDATE="update",t.UNSELECT="unselect",t.GENERATE="generate",t.REMOVE_PAGE="remove page",t.RACE="race",t.RESET="reset"}(q||(q={}));class B{listenersMap=new Map;addListener(t,e){this.listenersMap.has(t)||this.listenersMap.set(t,[]),this.listenersMap.get(t)?.push(e)}removeListener(t,e){this.listenersMap.get(t)?.filter((t=>t!==e))}notify(t,e){this.listenersMap.get(t)?.forEach((t=>t(e)))}reset(){this.listenersMap.forEach((t=>{t.length=0})),this.listenersMap.clear()}}!function(t){t.UPDATED="updated"}(V||(V={})),function(t){t.NEXT="next",t.PREV="prev",t.REQUEST_PAGE="request page",t.BEFORE_REQUEST="before request",t.PAGE_UPDATED="page updated"}(Y||(Y={}));class ${pageObserver=new B;totalCount=0;pageNum=1;constructor(t){this.pageLimit=t}pageUpdate(t,e){this.totalCount=t,void 0!==e&&(this.pageNum=e),this.pageObserver.notify(V.UPDATED,this)}onPageUpdate(t){this.pageObserver.addListener(V.UPDATED,t)}getPage(t){const{num:e}=t?this.getNext():this.getPrev();return e}getNext(){const t=this.totalCount-this.pageNum*this.pageLimit>0;return{num:this.pageNum+1,enabled:t}}getPrev(){const t=this.pageNum>1;return{num:this.pageNum-1,enabled:t}}}const F="http://127.0.0.1:3000";let H,X;!function(t){t.GET="GET",t.POST="POST",t.PUT="PUT",t.DELETE="DELETE"}(H||(H={})),function(t){t.GARAGE="/garage",t.ENGINE="/engine",t.WINNERS="/winners"}(X||(X={}));const J="X-Total-Count";let j,K,Q,Z,z,tt;function et(t,e){return t instanceof Object?e(t):null}function st(t,e){return Array.isArray(t)?t.map((t=>e(t))).filter((t=>null!==t)):[]}function it(t){return st(t,nt)}function at(t){return st(t,rt)}function nt(t){return et(t,(t=>"number"==typeof t.id&&"string"==typeof t.name&&"string"==typeof t.color?t:null))}function rt(t){return et(t,(t=>"number"==typeof t.id&&"number"==typeof t.wins&&"number"==typeof t.time?t:null))}function ot(t){return et(t,(t=>"number"==typeof t.velocity&&"number"==typeof t.distance?t:null))}function ht(t){return et(t,(t=>"boolean"==typeof t.success?t:null))}!function(t){t.PAGE="_page",t.LIMIT="_limit",t.SORT="_sort",t.ORDER="_order"}(j||(j={})),function(t){t.ID="id",t.STATUS="status"}(K||(K={})),function(t){t.STARTED="started",t.STOPPED="stopped",t.DRIVE="drive"}(Q||(Q={})),function(t){t.ID="id",t.WINS="wins",t.TIME="time"}(Z||(Z={})),function(t){t.INITIAL="initial",t.ASC="ASC",t.DESC="DESC"}(z||(z={})),function(t){t.USER_ABORT="4242",t.OK="200",t.BAD_REQUEST="400",t.NOT_FOUND="404",t.TOO_MANY_REQUESTS="429",t.INTERNAL_SERVER_ERROR="500"}(tt||(tt={}));class ct extends Error{constructor(){super("User interrupt REST API action")}}class lt extends Error{constructor(t){super(`\n${t.url}\n${t.status} ${t.statusText}\n${t.type}`)}}class dt extends lt{}class ut extends Error{constructor(t){super(`\n${t}\n${F}`)}}class pt extends Error{constructor(t){super(`Parse JSON Error: ${t}`)}}function mt(t,e={}){return`${F}${t}?${function(t){return Object.entries(t).map((([t,e])=>`${t}=${e}`)).join("&")}(e)}`}function gt(t=H.GET,e,s){const i={method:t};return i.headers=new Headers,e&&(i.body=JSON.stringify(e),i.headers.append("content-type","application/json")),s&&(i.signal=s),i}const Et=t=>gt(H.GET,void 0,t),wt=(t,e)=>gt(H.POST,t,e),bt=(t,e)=>gt(H.PUT,t,e),Rt=t=>gt(H.DELETE,void 0,t),St=(t=200)=>e=>{if(e.status===t)return null;switch(e.status){case 500:return new dt(e);default:return new lt(e)}};async function Tt({statusHandler:t=St(),url:e,init:s=Et()}){let i;try{i=await fetch(e,s)}catch(t){return t instanceof Error?t instanceof DOMException&&"AbortError"===t.name?new ct:new ut(t.message):null}return t(i)||i}async function Ct(t,e){let s;try{s=await t.json()}catch(t){return t instanceof Error?new pt(t.message):null}return e(s)}async function vt({validator:t,...e}){const s=await Tt(e);return s instanceof Response?Ct(s,t):s}async function ft(t,e){const s=await Tt(((t,e=7)=>({url:mt(X.GARAGE,{[j.PAGE]:t,[j.LIMIT]:e})}))(t,e));if(!(s instanceof Response))return s;const i=Number(s.headers.get(J))||0,a=await Ct(s,it);return Array.isArray(a)?{carDTOArray:a,totalCount:i||a.length}:a}async function yt(t){return vt({url:mt(`${X.GARAGE}/${t}`),init:Rt(),validator:()=>!0})}async function At({id:t,name:e,color:s}){return vt({url:mt(`${X.GARAGE}/${t}`),init:bt({name:e,color:s}),validator:nt})}const It=(t,e)=>mt(X.ENGINE,{[K.ID]:t,[K.STATUS]:e});async function Mt(t){return vt({url:It(t,Q.STOPPED),validator:ot})}async function Dt(t){return vt({url:mt(`${X.WINNERS}/${t}`),init:Rt(),validator:()=>!0})}class Pt extends ${cars=new Array;constructor(){super(7)}updateCars(t){this.cars=t.map((t=>new b(t,null))),this.onCarsUpdate?.(this.cars)}add(t){if(this.cars.length>=this.pageLimit)return null;const e=new b(t,null);return this.cars.push(e),e}remove(t){this.cars=this.cars.filter((e=>e!==t))}}let Nt;!function(t){t.SUBMIT="submit",t.CANCEL="cancel"}(Nt||(Nt={}));const Ot={id:-1,name:"",color:"#ff0000"},Lt="input--38R6rOD8V";class Ut extends n{nameInput=i([Lt,"name--3QARSEVUN"],{tag:"input"});colorInput=i([Lt,"color--1YrZ6BIOM"],{tag:"input"});btnSubmit=new h(Nt.SUBMIT);btnCancel=new h(Nt.CANCEL);carView=new N(null,!0,["big-bug--2axAn4xy8"]);constructor(t,e=Ot){super("root--2ikLv1NXE"),this.initialCarDTO=e,this.btnSubmit.update(t),this.build(),this.init(),this.initBinds()}build(){const t=i("inputs-wrapper--3kVZYxvit"),e=i("btns-wrapper--2dayAGJH1"),s=i("car-wrapper--1YRszKyZb");t.append(this.nameInput,this.colorInput),e.append(this.btnSubmit.getRoot(),this.btnCancel.getRoot()),s.append(this.carView.getRoot()),this.root.append(t,s,e)}init(){this.nameInput.type="text",this.colorInput.type="color",this.nameInput.value=this.initialCarDTO.name,this.colorInput.value=this.initialCarDTO.color,this.carView.applayDTO(this.carDTO)}initBinds(){this.btnSubmit.onClick((()=>this.submit())),this.btnCancel.onClick((()=>this.cancel())),this.nameInput.addEventListener("input",(()=>this.inputHandler())),this.colorInput.addEventListener("input",(()=>this.inputHandler())),this.inputHandler(),this.btnSubmit.disable()}get carDTO(){return{id:this.initialCarDTO.id,name:this.nameInput.value,color:this.colorInput.value}}inputHandler(){this.carView.applayDTO(this.carDTO),this.btnSubmit.switch(!!this.nameInput.value)}submit(){this.onSubmit&&this.onSubmit(this.carDTO)}cancel(){this.reset(),this.onCancel?.(),this.btnSubmit.disable()}reset(){this.nameInput.value=this.initialCarDTO.name,this.colorInput.value=this.initialCarDTO.color,this.carView.applayDTO(this.initialCarDTO)}}let xt,_t;!function(t){t.SELECT="select",t.REMOVE="remove",t.START="A",t.STOP="B"}(xt||(xt={})),function(t){t.INITIAL="initial",t.DRIVE="drive",t.EMPTY="empty"}(_t||(_t={}));class Gt extends n{place=i("place--286rjQUvG",{tag:"span"});time=i("time--g15Cs9mkn",{tag:"span"});name=i("name--3r1CtiLm4",{tag:"span"});constructor(t){super(["info--3b__Yk0cs",t]),this.build()}build(){this.root.append(this.place,this.time,this.name)}reset(t){this.place.textContent="",this.time.textContent="",this.name.textContent=t?.name||""}update(t,e){this.place.textContent=`${t}`,this.time.textContent=`${e.time}s`,this.name.textContent=e.name}}const kt="show-info--YFHRIKaFY",Wt="place1--10jpx9J-K",qt="place2--1rFtSepIs",Vt="place3--21YUMCJbE",Yt="neon--18KkGJN7J";class Bt extends n{stateMap=new Map;btnStart=new h(xt.START,o.START);btnStop=new h(xt.STOP,o.STOP);track=i("track--e7Dibkwqx");name=i("name--3qJqlJZw_");info=new Gt("info--3ujLU1IUQ");carModel=null;carView=new N(this.carModel);constructor(){super("root--3YCL6Wxhy"),this.build(),this.init(),this.initStateMap(),this.reset()}get buttons(){return[this.btnStart,this.btnStop]}build(){const t=i("btns-wrapper--9-sNwqyKG");t.append(...this.buttons.map((t=>t.getRoot()))),this.root.append(t);const e=i("body--2Ww2DFNF7");e.append(this.track),this.track.append(this.name,this.info.getRoot(),this.carView.getRoot()),this.root.append(t,e)}init(){this.btnStart.onClick((()=>this.start())),this.btnStop.onClick((()=>this.stop())),this.carView.onSelect=()=>this.onSelect?.(this.carModel),this.carView.onRemove=()=>this.remove(),this.setCssState(kt,!1)}initStateMap(){this.stateMap.set(_t.INITIAL,(()=>this.toInitialState())),this.stateMap.set(_t.DRIVE,(()=>this.toRunState())),this.stateMap.set(_t.EMPTY,(()=>this.toEmptyState()))}deselect(){this.carView.deselect()}async remove(){this.carModel&&this.onRemove&&(this.switch(_t.EMPTY),await(this.onRemove?.(this.carModel)),this.switch(_t.INITIAL))}async start(){this.carModel&&this.onStart&&(this.switch(_t.DRIVE),await(this.onStart?.(this.carModel)))}async stop(){this.carModel&&this.onStop&&(await(this.onStop?.(this.carModel)),this.switch(_t.INITIAL))}reset(){this.carModel?.reset(),this.carModel=null,this.name.textContent="",this.carView.update(null),this.switch(_t.EMPTY)}update(t){t!==this.carModel&&(t?(this.carModel=t,t.onUpdate=t=>{this.updateName(t),this.carView.update(t)},t.onDrive=t=>this.carView.applyCarModelState(t),this.updateName(t),this.carView.update(t),this.switch(_t.INITIAL)):this.reset())}updateName(t){this.name.textContent=t.name}switch(t=_t.INITIAL){this.stateMap.get(t)?.()}toInitialState(){this.btnStart.switch(!0),this.btnStop.switch(!1),this.setCssState(kt,!1),this.show()}toRunState(){this.btnStart.switch(!1),this.btnStop.switch(!0)}toEmptyState(){this.btnStart.switch(!1),this.btnStop.switch(!1)}show(t){if(t&&this.carModel)switch(this.info.update(t,this.carModel),this.setCssState(kt,!0),t<4&&this.setCssState(Yt,!0),t){case 1:this.setCssState(Wt,!0);break;case 2:this.setCssState(qt,!0);break;case 3:this.setCssState(Vt,!0)}else this.info.reset(this.carModel),this.setCssState(kt,!1),this.setCssState(Yt,!1),this.setCssState(Wt,!1),this.setCssState(qt,!1),this.setCssState(Vt,!1)}}const $t="hidden--jDoXiAnxY",Ft="btn--3D25ZFKe5";class Ht extends n{pageObserver=new B;pageNum=i("pageNum--2WgljGFm5");btnPrev=new h("",o.PREV,[Ft,"prev--o1TN36U8J"]);btnNext=new h("",o.NEXT,[Ft,"next--IG9NPUYZF"]);content=i("content--1usPoktt9");constructor(t,e,s="",i){super(["page--1-RUClzwv",s]),this.pageModel=t,this.pageName=e,this.popup=i,this.pageName=e,this.buildPage(),this.initPageBinds(),this.updatePage(t)}buildPage(){const t=i("paginatorWrapper--2oOQIiBfP"),e=i("paginator--1ykrOWiyU");e.append(this.btnPrev.getRoot(),this.pageNum,this.btnNext.getRoot()),t.append(e),this.root.append(this.content,t)}initPageBinds(){this.btnPrev.onClick((()=>this.requestPage(Y.PREV))),this.btnNext.onClick((()=>this.requestPage(Y.NEXT))),this.btnPrev.disable(),this.btnNext.disable()}updatePage(t){this.pageModel||(this.pageModel=t),this.btnPrev.switch(this.pageModel.getPrev().enabled),this.btnNext.switch(this.pageModel.getNext().enabled),this.pageNum.textContent=`Page #${t.pageNum}`,this.pageObserver.notify(Y.PAGE_UPDATED,`${this.pageName} (${t.totalCount})`)}requestPage(t){this.hookRequestPage?.(),this.pageObserver.notify(Y.REQUEST_PAGE,this.pageModel.getPage(t===Y.NEXT))}onRequestPage(t){this.pageObserver.addListener(Y.REQUEST_PAGE,t)}onPageUpdated(t){this.pageObserver.addListener(Y.PAGE_UPDATED,t)}show(){this.setCssState($t,!1)}hide(){this.setCssState($t,!0)}}const Xt="btns-wrapper--DH0_EuQRl",Jt="btn--3UHd_-cag",jt="btn-race--32syQCpMr";class Kt extends Ht{btnAddCar=new h(q.ADD,o.DEFAULT,Jt);btnUpdateCar=new h(q.UPDATE,o.DEFAULT,Jt);btnUnselect=new h(q.UNSELECT,o.DEFAULT,Jt);btnGenerate=new h(q.GENERATE,o.DEFAULT,Jt);btnRemovePage=new h(q.REMOVE_PAGE,o.DEFAULT,Jt);btnStartRace=new h(q.RACE,o.START,jt);btnResetRace=new h(q.RESET,o.STOP,jt);selected=null;tracks=Array.from({length:7},(()=>new Bt));constructor(t,e){super(t,"Garage","garage--lig70blrd",e),this.build(t),this.initBinds()}get buttons(){return[this.btnAddCar,this.btnUpdateCar,this.btnUnselect,this.btnGenerate,this.btnRemovePage]}build(t){const e=i("controls--2p0bK3ztP"),s=i([Xt,"btns-car--3-BJvWomw"]),a=i([Xt,"btns-race--2X1QdEwdD"]),n=i("tracks--3k4uu0-4_");e.append(s,a),this.content.append(e,n),s.append(...this.buttons.map((t=>t.getRoot()))),a.append(this.btnStartRace.getRoot(),this.btnResetRace.getRoot()),n.append(...this.tracks.map((t=>t.getRoot()))),this.tracks.forEach(((e,s)=>e.update(t.cars[s])))}initBinds(){this.btnAddCar.onClick((()=>this.requestAddCar())),this.btnUpdateCar.onClick((()=>this.requestUpdateCar())),this.btnUnselect.onClick((()=>this.deselect())),this.btnGenerate.onClick((()=>this.requestGenerateCars())),this.btnRemovePage.onClick((()=>this.requestRemovePage())),this.btnStartRace.onClick((()=>this.requestStartRace())),this.btnResetRace.onClick((()=>this.requestResetRace())),this.btnUpdateCar.disable(),this.btnUnselect.disable(),this.btnResetRace.disable(),this.tracks.forEach((t=>this.bindTrack(t)))}requestAddCar(){const t=new Ut(q.ADD);t.onSubmit=t=>this.submitAddCar(t),this.popup.render(q.ADD,t.getRoot())}requestUpdateCar(){const t=new Ut(q.UPDATE,this.selected?.carDTO);t.onSubmit=t=>this.submitUpdateCar(t),this.popup.render(q.UPDATE,t.getRoot())}bindTrack(t){t.onSelect=()=>this.select(t),t.onRemove=t=>this.requestRemoveCar(t),t.onStart=t=>this.requestStartCar(t),t.onStop=t=>this.requestStopCar(t)}select(t){t.carModel&&(this.tracks.filter((e=>e!==t)).forEach((t=>t.deselect())),this.selected=t.carModel,this.btnUpdateCar.enable(),this.btnUnselect.enable())}deselect(){this.btnUpdateCar.disable(),this.btnUnselect.disable(),this.tracks.forEach((t=>t.deselect())),this.selected=null}hookRequestPage=()=>{this.deselect(),this.tracks.forEach((t=>t.show()))};requestRemovePage=()=>{this.deselect(),this.onRequestRemovePage?.()};updateCars(t){this.tracks.forEach(((e,s)=>e.update(t[s]))),this.btnStartRace.enable(),this.btnResetRace.disable()}handleError(t){this.popup.showText(t.name,t.message)}showFinisher(t,e){this.tracks.find((t=>t.carModel===e))?.show(t)}getCarTracks(){return this.tracks.filter((t=>null!==t.carModel))}addCar(t){t&&this.tracks.find((t=>null===t.carModel))?.update(t)}async submitAddCar(t){this.addCar(await(this.onRequestAddCar?.(t))),await this.popup.hide()}async submitUpdateCar(t){await(this.onRequestUpdateCar?.(t)),await this.popup.hide()}async requestGenerateCars(t=100){const e=await(this.onRequestGenerateCars?.(t));e&&e.forEach((t=>this.addCar(t)))}async requestRemoveCar(t){t&&this.onRequestRemoveCar&&(this.selected=null,await(this.onRequestRemoveCar?.(t)))}async requestStartCar(t){t&&this.onRequestStartCar&&(this.btnResetRace.enable(),await(this.onRequestStartCar?.(t)))}async requestStopCar(t){t&&this.onRequestStopCar&&await(this.onRequestStopCar?.(t))}async requestStartRace(){this.tracks.forEach((t=>t.show())),this.btnStartRace.disable(),this.btnRemovePage.disable(),this.btnResetRace.enable(),this.getCarTracks().forEach((t=>t.switch(_t.DRIVE)));const t=await(this.onRequestStartRace?.());t&&0!==t.length&&(this.btnStartRace.enable(),this.btnRemovePage.enable())}async requestResetRace(){this.tracks.forEach((t=>t.show())),this.btnStartRace.disable(),this.btnResetRace.disable(),this.btnRemovePage.disable(),this.getCarTracks().forEach((t=>t.switch(_t.EMPTY))),await(this.onRequestResetRace?.()),this.getCarTracks().forEach((t=>t.switch(_t.INITIAL))),this.btnStartRace.enable(),this.btnRemovePage.enable()}}class Qt{constructor(t,e,s,i){this.model=t,this.view=e,this.carsService=s,this.raceService=i,this.initSimpleBinds(),this.initHeavyBinds(),this.initRaceBinds(),this.carsService.onError((t=>this.view.handleError(t)))}async init(){await this.carsService.init(),await this.carsService.getGaragePage()}initSimpleBinds(){this.model.onPageUpdate((t=>this.view.updatePage(t))),this.model.onCarsUpdate=t=>this.view.updateCars(t),this.view.onRequestAddCar=t=>this.carsService.addCar(t),this.view.onRequestUpdateCar=t=>this.carsService.updateCar(t),this.view.onRequestGenerateCars=t=>this.carsService.generateRandomBugs(t)}initHeavyBinds(){this.view.onRequestPage((async t=>{await this.raceService.resetRace(),await this.carsService.getGaragePage(t)})),this.view.onRequestRemoveCar=async t=>{await this.raceService.resetRace(),await this.carsService.removeCar(t.id)},this.view.onRequestRemovePage=async()=>{await this.raceService.resetRace(),await this.carsService.removeGaragePage()}}initRaceBinds(){this.view.onRequestStartCar=t=>this.raceService.startAndDrive(t),this.view.onRequestStopCar=t=>this.raceService.stop(t),this.view.onRequestStartRace=()=>this.raceService.startRace(),this.view.onRequestResetRace=()=>this.raceService.resetRace(),this.raceService.onFinish=(t,e)=>this.view.showFinisher(t,e)}}class Zt extends ${cars=new Array;constructor(){super(10)}updateWinners(t){this.cars=t,this.onWinnersUpdate?.(t)}get(t){return this.cars.find((e=>e.id===t))||null}add(t){return this.cars.length>=this.pageLimit?null:(this.cars.push(t),t)}remove(t){this.cars=this.cars.filter((e=>e.id!==t))}}let zt;!function(t){t.EMPTY="empty",t.RECORD="record"}(zt||(zt={}));const te="cell--3ZCUeOz9o",ee="hidden--3_lrTaEiE";class se extends n{num=i([te,"num--2DSDYQECm"],{tag:"td"});car=i([te,"car---gj69PBty"],{tag:"td"});name=i([te,"name--1xRhVyghP"],{tag:"td"});wins=i([te,"wins--1fYmMC0vf"],{tag:"td"});time=i([te,"time--3y3JBYlmw"],{tag:"td"});state=zt.EMPTY;carView=new N(null,!0,["small-bug--1v897lR0a"]);get isEmpty(){return this.state===zt.EMPTY}constructor(t,e=null){super(["row--3P946rTeU"],{tag:"tr"}),this.build(),e&&this.update(t,e)}build(){this.car.append(this.carView.getRoot()),this.root.append(this.num,this.car,this.name,this.wins,this.time),this.reset()}update(t,e){if(t&&(this.num.textContent=t.toString()),!e)return void this.reset();const{name:s,wins:i,winTime:a}=e;this.state=zt.RECORD,this.carView.applayDTO(e.carDTO),this.car.classList.remove(ee),this.name.textContent=s,this.wins.textContent=`${i}`,this.time.textContent=`${a}`,e.onUpdate=e=>this.update(t,e)}reset(){this.state=zt.EMPTY,this.car.style.backgroundColor="",this.name.textContent="",this.wins.textContent="",this.time.textContent="",this.car.classList.add(ee)}}let ie;!function(t){t.NUM="number",t.CAR="car",t.NAME="name",t.WINS="wins",t.TIME="best time (seconds)"}(ie||(ie={}));const ae="cell--1zHUNsJgP",ne="order--3yu3TXjNR",re="asc--X9AJEfqn5",oe="desc--iKM3kpfJF";function*he(){for(;;)yield z.INITIAL,yield z.ASC,yield z.DESC}function ce(t,e){const s=e.next().value;switch(s){case z.ASC:t.classList.toggle(re,!0),t.classList.toggle(oe,!1);break;case z.DESC:t.classList.toggle(re,!1),t.classList.toggle(oe,!0);break;default:t.classList.toggle(re,!1),t.classList.toggle(oe,!1)}return s}class le extends n{num=i([ae,"num--3dLS6FoX2"],{tag:"th"});car=i([ae,"car--3AvyL9IuL"],{tag:"th"});name=i([ae,"name--1ouHT7BM1"],{tag:"th"});wins=i([ae,"wins--3Q6W2f8p2",ne],{tag:"th"});time=i([ae,"time--2E-Kuva0h",ne],{tag:"th"});winsOrderGenerator=he();timeOrderGenerator=he();winsOrder=this.winsOrderGenerator.next().value;timeOrder=this.timeOrderGenerator.next().value;constructor(){super("row--N8ysXnC-k",{tag:"tr"}),this.init()}init(){this.num.textContent=ie.NUM,this.car.textContent=ie.CAR,this.name.textContent=ie.NAME,this.wins.textContent=ie.WINS,this.time.textContent=ie.TIME,this.root.append(this.num,this.car,this.name,this.wins,this.time),this.wins.onclick=()=>this.requestSortWins(),this.time.onclick=()=>this.requestSortTime()}requestSortWins(){for(this.winsOrder=ce(this.wins,this.winsOrderGenerator);this.timeOrder!==z.INITIAL;)this.timeOrder=ce(this.time,this.timeOrderGenerator);this.onRequesSortWins?.(this.winsOrder)}requestSortTime(){for(this.timeOrder=ce(this.time,this.timeOrderGenerator);this.winsOrder!==z.INITIAL;)this.winsOrder=ce(this.wins,this.winsOrderGenerator);this.onRequesSortTime?.(this.timeOrder)}}class de extends Ht{table=i("table--2sS3hJdly",{tag:"table"});thead=i("thead--an6y6sE6Z",{tag:"thead"});tbody=i("tbody--2ePEId-H4",{tag:"tbody"});header=new le;winnerViews=Array.from({length:10},((t,e)=>new se(e+1)));sortType=Z.ID;sortOrder=z.INITIAL;constructor(t,e){super(t,"Winners","winners--atLxZAxel",e),this.initWinners()}initWinners(){this.thead.append(this.header.getRoot()),this.tbody.append(...this.winnerViews.map((t=>t.getRoot()))),this.table.append(this.thead,this.tbody),this.content.append(this.table),this.header.onRequesSortWins=t=>this.requesSortWins(t),this.header.onRequesSortTime=t=>this.requesSortTime(t)}requesSortWins(t){this.sortType=Z.WINS,this.sortOrder=t,this.onRequesSortWins?.(this.sortOrder)}requesSortTime(t){this.sortType=Z.TIME,this.sortOrder=t,this.onRequesSortTime?.(this.sortOrder)}handleError(t){this.popup.showText(t.name,t.message)}updateWinners(t){const e=this.pageModel.pageNum;this.winnerViews.forEach(((s,i)=>s.update(10*(e-1)+1+i,t[i])))}add(t){this.winnerViews.find((t=>t.isEmpty))?.update(null,t)}}class ue{constructor(t,e,s,i){this.model=t,this.view=e,this.carsService=s,this.raceService=i,this.initBinds()}init(){return this.carsService.getWinnersPage()}initBinds(){this.carsService.onError((t=>this.view.handleError(t))),this.model.onPageUpdate((t=>this.view.updatePage(t))),this.model.onWinnersUpdate=t=>this.view.updateWinners(t),this.raceService.onRaceWin((t=>this.carsService.addWinner(t))),this.carsService.onAddWinner=t=>this.view.add(t),this.view.onRequestPage((t=>this.carsService.getWinnersPage(t,this.view.sortType,this.view.sortOrder))),this.view.onRequesSortWins=t=>this.carsService.sortWins(t),this.view.onRequesSortTime=t=>this.carsService.sortTime(t)}}const pe=function(){let t;return async()=>{if(!t){const e=await fetch("./dataset/us-car-models-2020-brands.json");t=await e.json()}return t}}(),me=["Evil","Bad","Stupid","Silly","Dumb","Crazy","Naive","Slow","Silent","Big","Heavy","Small","Little","Illegal","Abstract","Virtual","Unknown","Unexpected","Empty","Duplicate","Invalid","Missing","­Corrupted­","General­","Native","Unsupported­"],ge=["I­O","Internal","Access­","Control","Locale­","Range","Reference","Export","Import","Date","Time","Syntax","Type","Style","Linter","­Parse","Reflection","Connection­","Runtime","Arithmetic­","Assertion­","Cast","URI","Stream","Protocol","Format­","Security­","­Operation","Read","Write","State","Server","Initializer","Verify","Promise","Event","Generator","Iterator","Memory","Stack","Service","Concurrent","Timeout­"],Ee=["Bug","Error","Warning","Exception","Fail","Failure","Halt","Abort","Break","Alert","Interrupt","Overflow","Reject","Fault","Damage","Crash","Glitch"];function we(t){const e=O(0,t.length-1),s=O(0,t[e].models.length-1);return`${t[e].brand} ${t[e].models[s]}`}function be(){const t=O(0,me.length-1),e=O(0,ge.length-1),s=O(0,Ee.length-1);return`${me[t]} ${ge[e]} ${Ee[s]}`}function Re(t=100){return Array.from({length:t},(()=>({id:-1,name:be(),color:L()})))}function Se(t){return null===t||t instanceof Error?null:t}function Te(t,e){return null===t?null:t instanceof Error?t:e(t)}function Ce(t,e,s){return null===t?null:t instanceof Error?(s(t),null):e(t)}var ve;!function(t){t[t.ERROR=0]="ERROR"}(ve||(ve={}));class fe{observer=new B;constructor(t,e){this.garageModel=t,this.winnersModel=e}async init(){const t=await ft(this.garageModel.pageNum,this.garageModel.pageLimit);await Te(t,(async({carDTOArray:t,totalCount:e})=>{if(4===e&&4===(s=t).length&&(({id:t,name:e,color:s})=>1===t&&"Tesla"===e&&"#e6e6fa"===s)(s[0])&&(({id:t,name:e,color:s})=>2===t&&"BMW"===e&&"#fede00"===s)(s[1])&&(({id:t,name:e,color:s})=>3===t&&"Mersedes"===e&&"#6c779f"===s)(s[2])&&(({id:t,name:e,color:s})=>4===t&&"Ford"===e&&"#ef3c40"===s)(s[3])){const t=Re(4);t.forEach(((t,e)=>{t.id=e+1})),await Promise.all(t.map((t=>At(t))))}var s}))}async getGaragePage(t){Ce(await ft(t||this.garageModel.pageNum,this.garageModel.pageLimit),(({carDTOArray:e,totalCount:s})=>{this.garageModel.pageUpdate(s,t||this.garageModel.pageNum),this.garageModel.updateCars(e)}),(t=>this.noifyError(t)))}async getWinnersPage(t,e,s){const i=await async function(t,e,s,i){const a=await Tt(((t,e=10,s=Z.ID,i=z.ASC)=>({url:mt(X.WINNERS,{[j.PAGE]:t,[j.LIMIT]:e,[j.SORT]:s,[j.ORDER]:i})}))(t,e,s,i));if(!(a instanceof Response))return a;const n=Number(a.headers.get(J))||0,r=await Ct(a,at);return Array.isArray(r)?{winDTOArray:r,totalCount:n||r.length}:r}(t||this.winnersModel.pageNum,this.winnersModel.pageLimit,e,s);await Ce(i,(async({winDTOArray:e,totalCount:s})=>{this.winnersModel.pageUpdate(s,t||this.winnersModel.pageNum);const i=(await Promise.all(e.map((async t=>{const e=Se(await async function(t){return vt({url:mt(`${X.GARAGE}/${t}`),validator:nt})}(t.id));return new b(e,t)})))).filter((t=>null!==t&&!(t instanceof Error)));this.winnersModel.updateWinners(i)}),(t=>this.noifyError(t)))}sortWins(t){return t===z.INITIAL?this.getWinnersPage():this.getWinnersPage(this.winnersModel.pageNum,Z.WINS,t)}sortTime(t){return t===z.INITIAL?this.getWinnersPage():this.getWinnersPage(this.winnersModel.pageNum,Z.TIME,t)}async addCar(t){const e=Se(await async function({name:t,color:e}){return vt({url:mt(X.GARAGE),init:wt({name:t,color:e}),statusHandler:St(201),validator:nt})}(t));return e?(this.garageModel.pageUpdate(this.garageModel.totalCount+1),this.garageModel.add(e)):null}async updateCar(t){const e=this.garageModel.cars.find((e=>e.id===t.id));e&&Te(await At(t),(t=>{e.update(t),this.winnersModel.cars.find((e=>e.id===t.id))?.update(t)}))}async generateRandomCars(t=100){const e=await function(t=100){return Promise.all(Array.from({length:t},(()=>async function(){return{id:-1,name:we(await pe()),color:L()}}())))}(t);return(await Promise.all(e.map((t=>this.addCar(t))))).filter((t=>null!==t))}async generateRandomBugs(t=100){const e=Re(t);return(await Promise.all(e.map((t=>this.addCar(t))))).filter((t=>null!==t))}async removeGaragePage(){const t=this.garageModel.cars.map((t=>yt(t.id))),e=this.garageModel.cars.map((t=>Dt(t.id)));await Promise.all(t),await this.getGaragePage(),(await Promise.all(e)).find((t=>!0===t))&&await this.getWinnersPage()}async removeCar(t){await Te(await yt(t),(async()=>{await Dt(t),this.garageModel.updateCars(this.garageModel.cars.filter((e=>e.id!==t))),this.winnersModel.updateWinners([]),await this.getGaragePage(),await this.getWinnersPage()}))}async addWinner(t){if(await this.updateWinner(t))return;const{id:e,time:s}=t,i=Se(await async function(t){return vt({url:mt(X.WINNERS),init:wt(t),statusHandler:St(201),validator:rt})}({id:e,wins:1,time:s}));if(!i)return;this.winnersModel.pageUpdate(this.winnersModel.totalCount+1),t.updateWin(i);const a=this.winnersModel.add(t);a&&this.onAddWinner?.(a)}async updateWinner(t){const{id:e,time:s}=t;let i=Se(await async function(t){return vt({url:mt(`${X.WINNERS}/${t}`),validator:rt})}(t.id));if(!i)return!1;const{wins:a,time:n}=i;if(i=Se(await async function({id:t,wins:e,time:s}){return vt({url:mt(`${X.WINNERS}/${t}`),init:bt({wins:e,time:s}),validator:rt})}({id:e,wins:a+1,time:Math.min(s,n)})),!i)return!1;const r=this.winnersModel.get(e);return r&&r.updateWin(i),!0}onError(t){this.observer.addListener(ve.ERROR,t)}noifyError(t){this.observer.notify(ve.ERROR,t)}}let ye;!function(t){t.PENDING="pending",t.FULFILLED="fulfilled",t.REJECTED="rejected"}(ye||(ye={}));class Ae{observer=new B;race=new Map;raceResults=[];raceStartTime=new Date;constructor(t,e){this.garageModel=t,this.winnersModel=e}abort(t){this.race.has(t)&&(this.race.get(t).abort(),this.race.delete(t))}async start(t){if(this.race.has(t))return;t.driveStart(10*(Math.random()+1));const e=Se(await async function(t){return vt({url:It(t,Q.STARTED),validator:ot})}(t.id));if(!e)return void t.driveReset();const{distance:s,velocity:i}=e;t.driveStart(Math.ceil(s/i)),this.race.set(t,new AbortController)}async stop(t){this.race.has(t)&&(this.abort(t),Se(await Mt(t.id))&&t.driveReset())}stopSync(t){this.race.has(t)&&(this.abort(t),Mt(t.id),t.driveReset())}async drive(t){if(!this.race.has(t))return null;const e=this.race.get(t),s=(i=(t.duration||1e4)+10,a=e,new Promise((t=>setTimeout(t,i,a))));var i,a;const n=async function(t,e){return vt({url:It(t,Q.DRIVE),init:Et(e),validator:ht})}(t.id,e.signal);t.driveMove();const r=await Promise.race([s,n]);return null===r?null:r instanceof Error?(t.driveDead(),null):(r instanceof AbortController&&r.abort(),t.driveFinish(),t)}async startAndDrive(t){await this.start(t),await this.drive(t)}abortRace(){0!==this.race.size&&(this.raceResults=[],[...this.race.keys()].map((t=>this.abort(t))))}async resetRace(){this.race.size>0&&(this.raceResults=[],await Promise.all([...this.race.keys()].map((t=>this.stop(t)))))}resetRaceSync(){0!==this.race.size&&(this.raceResults=[],[...this.race.keys()].map((t=>this.stopSync(t))))}async startRace(){await this.resetRace(),await Promise.all(this.garageModel.cars.map((t=>this.start(t))));const t=this.garageModel.cars.map((t=>this.drive(t)));return this.raceResults=[],this.raceStartTime=new Date,await this.doRace(t),this.raceResults}async doRace(t){if(0===t.length)return;const e=t.map((t=>t.then((e=>({car:e,promise:t}))))),{car:s,promise:i}=await Promise.race(e);if(s){this.raceResults.push(s);const t=this.raceResults.length;1===t&&this.notifyRaceWin(s),this.onFinish?.(t,s)}await this.doRace(t.filter((t=>t!==i)))}onRaceWin(t){this.observer.addListener(p.RACE_WIN,t)}notifyRaceWin(t){this.observer.notify(p.RACE_WIN,t)}}class Ie extends n{btnToAbout=new h(s.ABOUT,o.ROUTE,t);btnToGarage=new h(s.GARAGE,o.ROUTE,t);btnToWinners=new h(s.WINNERS,o.ROUTE,t);aboutView=new W;constructor(t=s.ABOUT){super("app--hIZJ1RoMS"),this.build(),this.init(),this.update(t)}build(){const t=new l,e=new m(t),s=new Pt,n=new Zt,r=new Kt(s,e),o=new de(n,e),h=new fe(s,n),c=new Ae(s,n);this.carsController=new Qt(s,r,h,c),this.winsController=new ue(n,o,h,c);const d=i("header--2RYU6WmLd",{tag:"header"}),u=i("wrapper--3uVR9_6_B");d.append(this.btnToAbout.getRoot(),this.btnToGarage.getRoot(),this.btnToWinners.getRoot()),u.append(this.aboutView.getRoot(),r.getRoot(),o.getRoot()),this.root.append(d,u,a('\n  <footer class="footer--1Vpt7TVyZ">\n    <div class="footer__wrapper--xx7cob4ia">\n      <a class="logo--6jXTxWm-a rss--32WyxUeSD" href="https://rs.school/js/">\n        <svg class="svg--1H42RH16p rss--32WyxUeSD">\n          <use href="./svg/sprite.svg#icon-rs-school-js"></use>\n        </svg>\n        <span class="text--3y91nhcxu rss--32WyxUeSD">\'21</span>\n      </a>\n      <div class="group--2lRZJ2xK8">\n        <a class="logo--6jXTxWm-a github--1S5KXahA4" href="https://github.com/dimonwhite">\n          <svg class="svg--1H42RH16p github--1S5KXahA4">\n            <use href="./svg/sprite.svg#icon-github"></use>\n          </svg>\n          <span class="text--3y91nhcxu github--1S5KXahA4">mentor<span class="spoiler--1dCvULlAA">: dimonwhite</span></span>\n        </a>\n        <a class="logo--6jXTxWm-a github--1S5KXahA4" href="https://github.com/fronte-finem">\n          <svg class="svg--1H42RH16p github--1S5KXahA4">\n            <use href="./svg/sprite.svg#icon-github"></use>\n          </svg>\n          <span class="text--3y91nhcxu github--1S5KXahA4">student<span class="spoiler--1dCvULlAA">: fronte-finem</span></span>\n        </a>         \n      </div>\n    </div>\n  </footer>\n')),this.root.append(t.getRoot(),e.getRoot())}init(){this.btnToAbout.onClick((()=>this.update(s.ABOUT))),this.btnToGarage.onClick((()=>this.update(s.GARAGE))),this.btnToWinners.onClick((()=>this.update(s.WINNERS))),this.carsController.view.onPageUpdated((t=>this.btnToGarage.update(t))),this.winsController.view.onPageUpdated((t=>this.btnToWinners.update(t)))}async start(){await this.carsController.init(),await this.winsController.init()}update(t){switch(t){case s.ABOUT:this.activate(this.aboutView,this.btnToAbout);break;case s.GARAGE:this.activate(this.carsController.view,this.btnToGarage);break;case s.WINNERS:this.activate(this.winsController.view,this.btnToWinners)}}get routerBtns(){return[this.btnToAbout,this.btnToGarage,this.btnToWinners]}get routerPages(){return[this.aboutView,this.carsController.view,this.winsController.view]}activate(t,s){t.show(),s.setCssState(e,!0),this.routerPages.filter((e=>e!==t)).forEach((t=>t.hide())),this.routerBtns.filter((t=>t!==s)).forEach((t=>t.setCssState(e,!1)))}}window.addEventListener("load",(async()=>{const t=new Ie;document.body.classList.add("root--3pk7p9P8N"),document.body.append(t.getRoot()),await t.start()}))})();